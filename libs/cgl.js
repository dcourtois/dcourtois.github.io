define("Math/Vec2",[],function(){"use strict";function e(e,t){2===arguments.length?(this[0]=e,this[1]=t):1===arguments.length?(this[0]=e[0],this[1]=e[1]):(this[0]=0,this[1]=0),this._floatArray=new Float32Array([0,0])}return e.prototype={toFloatArray:function(){return this._floatArray[0]=this[0],this._floatArray[1]=this[1],this._floatArray},set:function(e,t){return this[0]=e,this[1]=t,this},clone:function(){return new e(this[0],this[1])},copy:function(e){return this[0]=e[0],this[1]=e[1],this},lengthSq:function(){var e=this[0],t=this[1];return e*e+t*t},length:function(){return Math.sqrt(this.lengthSq())},distanceSq:function(e){var t=e[0]-this[0],i=e[1]-this[1];return t*t+i*i},distance:function(e){return Math.sqrt(this.distanceSq(e))},normalize:function(){var e=this.length();return this[0]/=e,this[1]/=e,this},dot:function(e){return this[0]*e[0]+this[1]*e[1]},cross:function(e,t){var i=e[0],n=e[1],r=t[0],s=t[1];return this[0]=n*r-s*i,this[1]=i*s-r*n,this},negate:function(e){return this[0]=-e[0],this[1]=-e[1],this},negateSelf:function(){return this[0]=-this[0],this[1]=-this[1],this},add:function(e,t){return this[0]=e[0]+t[0],this[1]=e[1]+t[1],this},addSelf:function(e){return this[0]+=e[0],this[1]+=e[1],this},addScalar:function(e,t){return this[0]=e[0]+t,this[1]=e[1]+t,this},addScalarSelf:function(e){return this[0]+=e,this[1]+=e,this},sub:function(e,t){return this[0]=e[0]-t[0],this[1]=e[1]-t[1],this},subSelf:function(e){return this[0]-=e[0],this[1]-=e[1],this},subScalar:function(e,t){return this[0]=e[0]-t,this[1]=e[1]-t,this},subScalarSelf:function(e){return this[0]-=e,this[1]-=e,this},mul:function(e,t){return this[0]=e[0]*t[0],this[1]=e[1]*t[1],this},mulSelf:function(e){return this[0]*=e[0],this[1]*=e[1],this},mulScalar:function(e,t){return this[0]=e[0]*t,this[1]=e[1]*t,this},mulScalarSelf:function(e){return this[0]*=e,this[1]*=e,this},div:function(e,t){return this[0]=e[0]/t[0],this[1]=e[1]/t[1],this},divSelf:function(e){return this[0]/=e[0],this[1]/=e[1],this},divScalar:function(e,t){return this[0]=e[0]/t,this[1]=e[1]/t,this},divScalarSelf:function(e){return this[0]/=e,this[1]/=e,this}},e}),define("Math/Vec3",[],function(){"use strict";function e(e,t,i){3===arguments.length?(this[0]=e,this[1]=t,this[2]=i):1===arguments.length?(this[0]=e[0],this[1]=e[1],this[2]=e[2]):(this[0]=0,this[1]=0,this[2]=0),this._floatArray=new Float32Array([0,0,0])}return e.prototype={toFloatArray:function(){return this._floatArray[0]=this[0],this._floatArray[1]=this[1],this._floatArray[2]=this[2],this._floatArray},equals:function(e){return this[0]===e[0]&&this[1]===e[1]&&this[2]===e[2]},set:function(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this},clone:function(){return new e(this[0],this[1],this[2])},copy:function(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this},lengthSq:function(){var e=this[0],t=this[1],i=this[2];return e*e+t*t+i*i},length:function(){return Math.sqrt(this.lengthSq())},distanceSq:function(e){var t=e[0]-this[0],i=e[1]-this[1],n=e[2]-this[2];return t*t+i*i+n*n},distance:function(e){return Math.sqrt(this.distanceSq(e))},normalize:function(){var e=this.length();return this[0]/=e,this[1]/=e,this[2]/=e,this},dot:function(e){return this[0]*e[0]+this[1]*e[1]+this[2]*e[2]},cross:function(e,t){var i=e[0],n=e[1],r=e[2],s=t[0],o=t[1],a=t[2];return this[0]=n*a-r*o,this[1]=r*s-i*a,this[2]=i*o-n*s,this},negate:function(e){return this[0]=-e[0],this[1]=-e[1],this[2]=-e[2],this},negateSelf:function(){return this[0]=-this[0],this[1]=-this[1],this[2]=-this[2],this},add:function(e,t){return this[0]=e[0]+t[0],this[1]=e[1]+t[1],this[2]=e[2]+t[2],this},addSelf:function(e){return this[0]+=e[0],this[1]+=e[1],this[2]+=e[2],this},addScalar:function(e,t){return this[0]=e[0]+t,this[1]=e[1]+t,this[2]=e[2]+t,this},addScalarSelf:function(e){return this[0]+=e,this[1]+=e,this[2]+=e,this},sub:function(e,t){return this[0]=e[0]-t[0],this[1]=e[1]-t[1],this[2]=e[2]-t[2],this},subSelf:function(e){return this[0]-=e[0],this[1]-=e[1],this[2]-=e[2],this},subScalar:function(e,t){return this[0]=e[0]-t,this[1]=e[1]-t,this[2]=e[2]-t,this},subScalarSelf:function(e){return this[0]-=e,this[1]-=e,this[2]-=e,this},mul:function(e,t){return this[0]=e[0]*t[0],this[1]=e[1]*t[1],this[2]=e[2]*t[2],this},mulSelf:function(e){return this[0]*=e[0],this[1]*=e[1],this[2]*=e[2],this},mulScalar:function(e,t){return this[0]=e[0]*t,this[1]=e[1]*t,this[2]=e[2]*t,this},mulScalarSelf:function(e){return this[0]*=e,this[1]*=e,this[2]*=e,this},div:function(e,t){return this[0]=e[0]/t[0],this[1]=e[1]/t[1],this[2]=e[2]/t[2],this},divSelf:function(e){return this[0]/=e[0],this[1]/=e[1],this[2]/=e[2],this},divScalar:function(e,t){return this[0]=e[0]/t,this[1]=e[1]/t,this[2]=e[2]/t,this},divScalarSelf:function(e){return this[0]/=e,this[1]/=e,this[2]/=e,this},toSpherical:function(){var e=this.length();return this[1]=Math.acos(this[1]/e),this[2]=Math.atan2(this[2],this[0]),this[0]=e,this},toCartesian:function(){var e=this[0],t=this[1],i=this[2],n=Math.sin(t);return this[0]=e*n*Math.cos(i),this[1]=e*Math.cos(t),this[2]=e*n*Math.sin(i),this}},e}),define("Math/Vec4",[],function(){"use strict";function e(e,t,i,n){4===arguments.length?(this[0]=e,this[1]=t,this[2]=i,this[3]=n):1===arguments.length?(this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3]):(this[0]=0,this[1]=0,this[2]=0,this[3]=0),this._floatArray=new Float32Array([0,0,0,0])}return e.prototype={toFloatArray:function(){return this._floatArray[0]=this[0],this._floatArray[1]=this[1],this._floatArray[2]=this[2],this._floatArray[3]=this[3],this._floatArray},set:function(e,t,i,n){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this},clone:function(){return new e(this[0],this[1],this[2],this[3])},copy:function(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this},lengthSq:function(){var e=this[0],t=this[1],i=this[2],n=this[3];return e*e+t*t+i*i+n*n},length:function(){return Math.sqrt(this.lengthSq())},distanceSq:function(e){var t=e[0]-this[0],i=e[1]-this[1],n=e[2]-this[2],r=e[3]-this[3];return t*t+i*i+n*n+r*r},distance:function(e){return Math.sqrt(this.distanceSq(e))},normalize:function(){var e=this.length();return this[0]/=e,this[1]/=e,this[2]/=e,this[3]/=e,this},dot:function(e){return this[0]*e[0]+this[1]*e[1]+this[2]*e[2]+this[3]*e[3]},cross:function(e,t){var i=e[0],n=e[1],r=e[2],s=e[3],o=t[0],a=t[1],h=t[2],u=t[3];return this[0]=n*h-a*r,this[1]=r*u-h*s,this[2]=s*o-u*i,this[3]=i*a-o*n,this},negate:function(e){return this[0]=-e[0],this[1]=-e[1],this[2]=-e[2],this[3]=-e[3],this},negateSelf:function(){return this[0]=-this[0],this[1]=-this[1],this[2]=-this[2],this[3]=-this[3],this},add:function(e,t){return this[0]=e[0]+t[0],this[1]=e[1]+t[1],this[2]=e[2]+t[2],this[3]=e[3]+t[3],this},addSelf:function(e){return this[0]+=e[0],this[1]+=e[1],this[2]+=e[2],this[3]+=e[3],this},addScalar:function(e,t){return this[0]=e[0]+t,this[1]=e[1]+t,this[2]=e[2]+t,this[3]=e[3]+t,this},addScalarSelf:function(e){return this[0]+=e,this[1]+=e,this[2]+=e,this[3]+=e,this},sub:function(e,t){return this[0]=e[0]-t[0],this[1]=e[1]-t[1],this[2]=e[2]-t[2],this[3]=e[3]-t[3],this},subSelf:function(e){return this[0]-=e[0],this[1]-=e[1],this[2]-=e[2],this[3]-=e[3],this},subScalar:function(e,t){return this[0]=e[0]-t,this[1]=e[1]-t,this[2]=e[2]-t,this[3]=e[3]-t,this},subScalarSelf:function(e){return this[0]-=e,this[1]-=e,this[2]-=e,this[3]-=e,this},mul:function(e,t){return this[0]=e[0]*t[0],this[1]=e[1]*t[1],this[2]=e[2]*t[2],this[3]=e[3]*t[3],this},mulSelf:function(e){return this[0]*=e[0],this[1]*=e[1],this[2]*=e[2],this[3]*=e[3],this},mulScalar:function(e,t){return this[0]=e[0]*t,this[1]=e[1]*t,this[2]=e[2]*t,this[3]=e[3]*t,this},mulScalarSelf:function(e){return this[0]*=e,this[1]*=e,this[2]*=e,this[3]*=e,this},div:function(e,t){return this[0]=e[0]/t[0],this[1]=e[1]/t[1],this[2]=e[2]/t[2],this[3]=e[3]/t[3],this},divSelf:function(e){return this[0]/=e[0],this[1]/=e[1],this[2]/=e[2],this[3]/=e[3],this},divScalar:function(e,t){return this[0]=e[0]/t,this[1]=e[1]/t,this[2]=e[2]/t,this[3]=e[3]/t,this},divScalarSelf:function(e){return this[0]/=e,this[1]/=e,this[2]/=e,this[3]/=e,this}},e}),define("Utils/IDArray",[],function(){"use strict";function e(){this._elements=[]}return e.prototype={add:function(e){for(var t=this._elements,i=0;i<t.length;++i)if(void 0===t[i])return t[i]=e,i;return t.push(e),t.length-1},remove:function(e){e>=0&&e<this._elements.length&&delete this._elements[e]},get:function(e){return e>=0&&e<this._elements.length?this._elements[e]:void 0},apply:function(e){for(var t=this._elements,i=void 0,n=0;n<t.length;++n)i=t[n],void 0!==i&&e(i)},clear:function(){this._elements.length=0}},e}),define("Utils/Utils",[],function(){"use strict";var e=function(e,t){if(void 0!==e.prototype._base)throw"[inherits] Multiple inheritance not supported";e.prototype._base=new t;for(var i in t.prototype)void 0===e.prototype[i]&&(e.prototype[i]=t.prototype[i])},t=function(e){return JSON.parse(JSON.stringify(e))},i=function(e,t){if(t){var i=console.log;console.log=function(t){i.bind(console)(t),e(t)}}else console.log=function(t){e(t)}},n=function(e,t){if(void 0!==e&&void 0!==t){if("string"==typeof t)return e[t];if("object"==typeof t&&t.length){for(var i=0;i<t.length;++i)if(e=n(e,t[i]),void 0===e)return;return e}}};return{inherits:e,clone:t,setLog:i,getMember:n}}),define("Animation/AnimationSystem",["Math/Vec2","Math/Vec3","Math/Vec4","Utils/IDArray","Utils/Utils"],function(e,t,i,n,r){"use strict";function s(e){this.engine=e,this.animations=new n,this.paused=!1,this.currentTime=0}return s.prototype={update:function(e,t){this.paused||(this.currentTime+=e,t=this.currentTime,this.animations.apply(function(e){for(var i=t%e.duration,n=e.data,r=n.length,s=e._lastKey,o=(s+1)%r,a=n[s].time,h=s>o?n[o].time+e.duration:n[o].time;a>i||i>h;)s=(s+1)%r,o=(s+1)%r,a=n[s].time,h=s>o?n[o].time+e.duration:n[o].time;e._lastKey=s;var a=n[s].time,h=n[o].time,u=(i-a)/(h-a),c=e.interpolate(n[s].value,n[o].value,u);e.set(c)}))},addAnimation:function(e,t){this._idMap=t;var i={data:r.clone(e.data),set:this._createSetter(e),interpolate:this._createInterpolator(e),duration:e.duration,_lastKey:0};if(void 0!==i.interpolate&&void 0!==i.set&&void 0!==i.data&&void 0!==i.data)return delete this._idMap,this.animations.add(i)},_createInterpolator:function(n){switch(n.interpolator){case"LINEAR":switch(n.size){case 1:return function(e,t,i){return e+(t-e)*i};case 2:return function(){var t=new e;return function(e,i,n){return t.sub(i,e),t.mulScalarSelf(n),t.addSelf(e)}}();case 3:return function(){var e=new t;return function(t,i,n){return e.sub(i,t),e.mulScalarSelf(n),e.addSelf(t)}}();case 4:return function(){var e=new i;return function(t,i,n){return e.sub(i,t),e.mulScalarSelf(n),e.addSelf(t)}}()}}},_createSetter:function(n){var r=n.target;switch(r.type){case"component":var s=r.nodeID;void 0!==this._idMap&&(s=this._idMap[s],void 0===s&&(s=r.nodeId));var o=this.engine.sceneGraph.find("id",s,!0);if(void 0===o)break;var a=o.getComponent(r.componentType);if(void 0===a)break;var h=a[r.property];if(void 0===h)break;switch(typeof h){case"function":return h.bind(a);case"number":return function(){var e=a,t=r.property;return function(i){e[t]=i}}()}if(h instanceof e||h instanceof t||h instanceof i)return function(){var e=h;return function(t){e.copy(t)}}()}}},s}),define("Core/EventHandler",["Utils/IDArray"],function(e){"use strict";function t(t){this.useCapture=!0,this.keyboardElement=void 0,this.mouseElement=void 0,this._listeners=new e,this.init(t)}return t.EVENTS={KEYDOWN:1,KEYUP:2,MOUSEDOWN:3,MOUSEUP:4,MOUSEMOVE:5,MOUSEDOUBLE:6,VIEWPORT:7},t.KEYS={ESCAPE:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123},t.MOUSEBUTTONS={LEFT:0,MIDDLE:1,RIGHT:2},t.prototype={init:function(e){e=e||{},e.keyboardElement&&this.startKeyboard(e.keyboardElement),e.mouseElement&&this.startMouse(e.mouseElement),e.disableContextMenu&&this.disableContextMenu(),e.useCapture&&(this.useCapture=e.useCapture)},deinit:function(){this.stop()},isKeyboardHandled:function(){return void 0!==this.keyboardElement},isMouseHandled:function(){return void 0!==this.mouseElement},startKeyboard:function(e){void 0!==e&&(this.keyboardElement=e,e.addEventListener("keydown",this._keyDown.bind(this),this.useCapture),e.addEventListener("keyup",this._keyUp.bind(this),this.useCapture))},startMouse:function(e){void 0!==e&&(this.mouseElement=e,e.addEventListener("mousedown",this._mouseDown.bind(this),this.useCapture),e.addEventListener("mousemove",this._mouseMove.bind(this),this.useCapture),e.addEventListener("mouseup",this._mouseUp.bind(this),this.useCapture),e.addEventListener("dblclick",this._mouseDouble.bind(this),this.useCapture))},start:function(e){this.startKeyboard(e),this.startMouse(e)},stopKeyboard:function(){this.isKeyboardHandled()===!0&&(this.keyboardElement.removeEventListener("keydown",this._keyDown.bind(this)),this.keyboardElement.removeEventListener("keyup",this._keyUp.bind(this)))},stopMouse:function(){this.isMouseHandled()===!0&&(this.mouseElement.removeEventListener("mousedown",this._mouseDown.bind(this)),this.mouseElement.removeEventListener("mousemove",this._mouseMove.bind(this)),this.mouseElement.removeEventListener("mouseup",this._mouseUp.bind(this)),this.mouseElement.removeEventListener("dblclick",this._mouseDouble.bind(this)))},stop:function(){this.stopKeyboard(),this.stopMouse()},disableContextMenu:function(){document.oncontextmenu=function(e){return e.preventDefault(),!1}},enableContextMenu:function(){document.oncontextmenu=function(){return!0}},addEventListener:function(e,t){return this._listeners.add({object:e,method:t})},removeEventListener:function(e){this._listeners.remove(e)},_mouseDown:function(e){e.preventDefault(),this._listeners.apply(function(i){i.method.bind(i.object)({type:t.EVENTS.MOUSEDOWN,button:e.button,x:e.clientX,y:e.clientY})})},_mouseUp:function(e){e.preventDefault(),this._listeners.apply(function(i){i.method.bind(i.object)({type:t.EVENTS.MOUSEUP,button:e.button,x:e.clientX,y:e.clientY})})},_mouseMove:function(e){e.preventDefault(),this._listeners.apply(function(i){i.method.bind(i.object)({type:t.EVENTS.MOUSEMOVE,button:e.button,x:e.clientX,y:e.clientY})})},_mouseDouble:function(e){e.preventDefault(),this._listeners.apply(function(i){i.method.bind(i.object)({type:t.EVENTS.MOUSEDOUBLE,button:e.button,x:e.clientX,y:e.clientY})})},_keyDown:function(e){this._listeners.apply(function(i){i.method.bind(i.object)({type:t.EVENTS.KEYDOWN,key:e.keyCode,shift:e.shiftKey,ctrl:e.ctrlKey,alt:e.altKey})})},_keyUp:function(e){this._listeners.apply(function(i){i.method.bind(i.object)({type:t.EVENTS.KEYUP,key:e.keyCode,shift:e.shiftKey,ctrl:e.ctrlKey,alt:e.altKey})})},_onresize:function(e,i){this._listeners.apply(function(n){n.method.bind(n.object)({type:t.EVENTS.VIEWPORT,x:0,y:0,width:e,height:i})})}},t}),define("Math/Mat4",["./Vec3"],function(e){"use strict";function t(e,t,i,n,r,s,o,a,h,u,c,d,f,l,p,v){1===arguments.length?this.elements=new Float32Array([e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]):16===arguments.length?this.elements=new Float32Array([e,t,i,n,r,s,o,a,h,u,c,d,f,l,p,v]):this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}var i=new e,n=new e,r=new e;t.prototype={identity:function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},copy:function(e){var t=void 0!==e.elements?e.elements:e,i=this.elements;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],this},rotationX:function(e){var t=Math.cos(e),i=Math.sin(e),n=this.elements;return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=t,n[6]=i,n[7]=0,n[8]=0,n[9]=-i,n[10]=t,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this},rotationY:function(e){var t=Math.cos(e),i=Math.sin(e),n=this.elements;return n[0]=t,n[1]=0,n[2]=-i,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=i,n[9]=0,n[10]=t,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this},rotationZ:function(e){var t=Math.cos(e),i=Math.sin(e),n=this.elements;return n[0]=t,n[1]=i,n[2]=0,n[3]=0,n[4]=-i,n[5]=t,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this},rotationXYZ:function(e,t,n){var r=s,o=this.elements,a=i;return a.set(o[12],o[13],o[14]),this.mul(r.rotationY(t),this.rotationX(e)).mulSelf(r.rotationZ(n)),o[12]=a[0],o[13]=a[1],o[14]=a[2],this},translation:function(e,t,i){var n=this.elements;return n[0]=0,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e,n[13]=t,n[14]=i,n[15]=1,this},lookAt:function(e,t,s){var o=this.elements,a=i.sub(e,t).normalize(),h=n.cross(s,a).normalize(),u=r.cross(a,h);return o[0]=h[0],o[1]=u[0],o[2]=a[0],o[3]=0,o[4]=h[1],o[5]=u[1],o[6]=a[1],o[7]=0,o[8]=h[2],o[9]=u[2],o[10]=a[2],o[11]=0,o[12]=-e.dot(h),o[13]=-e.dot(u),o[14]=-e.dot(a),o[15]=1,this},projection:function(e,t,i,n){var r=this.elements,s=i*Math.tan(.5*e),o=s*t,a=i-n;return r[0]=i/o,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=i/s,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=(n+i)/a,r[11]=-1,r[12]=0,r[13]=0,r[14]=2*n*i/a,r[15]=0,this},determinant:function(){var e=(this.elements,m[0]),t=m[4],i=m[8],n=m[12],r=m[1],s=m[5],o=m[9],a=m[13],h=m[2],u=m[6],c=m[10],d=m[14],f=m[3],l=m[7],p=m[11],v=m[15];return e*s*c*v+e*o*d*l+e*a*u*p+t*r*d*p+t*o*h*v+t*a*c*f+i*r*u*v+i*s*d*f+i*a*h*l+n*r*c*l+n*s*h*p+n*o*u*f+e*s*d*p-e*o*u*v-e*a*c*l-t*r*c*v-t*o*d*f-t*a*h*p-i*r*d*l-i*s*h*v-i*a*u*f-n*r*u*p-n*s*c*f-n*o*h*l},removeScale:function(e){var t=e.elements,n=this.elements;i.set(t[0],t[4],t[8]).normalize(),n[0]=i[0],n[4]=i[1],n[8]=i[2],i.set(t[1],t[5],t[9]).normalize(),n[1]=i[0],n[5]=i[1],n[9]=i[2],i.set(t[2],t[6],t[10]).normalize(),n[2]=i[0],n[6]=i[1],n[10]=i[2]},inverse:function(e){var t=e.elements,i=this.elements,n=t[0],r=t[4],s=t[8],o=t[12],a=t[1],h=t[5],u=t[9],c=t[13],d=t[2],f=t[6],l=t[10],p=t[14],v=t[3],g=t[7],m=t[11],_=t[15],b=l*_-m*p,y=f*_-g*p,E=f*m-g*l,T=d*_-v*p,x=d*m-v*l,R=d*g-v*f,S=u*_-m*c,w=h*_-g*c,M=h*m-g*u,L=a*_-v*c,C=a*m-v*u,P=h*_-g*c,A=a*g-v*h,B=u*p-l*c,D=h*p-f*c,I=h*l-f*u,U=a*p-d*c,F=a*l-d*u,N=a*f-d*h;i[0]=+h*b-u*y+c*E,i[1]=-a*b+u*T-c*x,i[2]=+a*y-h*T+c*R,i[3]=-a*E+h*x-u*R,i[4]=-r*b+s*y-o*E,i[5]=+n*b-s*T+o*x,i[6]=-n*y+r*T-o*R,i[7]=+n*E-r*x+s*R,i[8]=+r*S-s*w+o*M,i[9]=-n*S+s*L-o*C,i[10]=+n*P-r*L+o*A,i[11]=-n*M+r*C-s*A,i[12]=-r*B+s*D-o*I,i[13]=+n*B-s*U+o*F,i[14]=-n*D+r*U-o*N,i[15]=+n*I-r*F+s*N;var O=+n*n+r*a+s*d+o*v;return i[0]/=O,i[1]/=O,i[2]/=O,i[3]/=O,i[4]/=O,i[5]/=O,i[6]/=O,i[7]/=O,i[8]/=O,i[9]/=O,i[10]/=O,i[11]/=O,i[12]/=O,i[13]/=O,i[14]/=O,i[15]/=O,this},inverseSelf:function(){return m0.copy(this),this.inverse(m0)},transpose:function(e){var t=this.elements,i=e.elements;return t[0]=i[0],t[4]=i[1],t[8]=i[2],t[12]=i[3],t[1]=i[4],t[5]=i[5],t[9]=i[6],t[13]=i[7],t[2]=i[8],t[6]=i[9],t[10]=i[10],t[14]=i[11],t[3]=i[12],t[7]=i[13],t[11]=i[14],t[15]=i[15],this},transposeSelf:function(){return m0.copy(this),this.transpose(m0)},inverseFast:function(e){var t=this.elements,i=e.elements,n=i[0],r=i[4],s=i[8],o=i[12],a=i[1],h=i[5],u=i[9],c=i[13],d=i[2],f=i[6],l=i[10],p=i[14];return t[0]=n,t[4]=a,t[8]=d,t[1]=r,t[5]=h,t[9]=f,t[2]=s,t[6]=u,t[10]=l,t[12]=-(o*n+c*a+p*d),t[13]=-(o*r+c*h+p*f),t[14]=-(o*s+c*u+p*l),t[3]=0,t[7]=0,t[11]=0,t[15]=1,this},mul:function(e,t){var i=this.elements,n=e.elements,r=t.elements,s=n[0],o=n[1],a=n[2],h=n[3],u=n[4],c=n[5],d=n[6],f=n[7],l=n[8],p=n[9],v=n[10],g=n[11],m=n[12],_=n[13],b=n[14],y=n[15],E=r[0],T=r[1],x=r[2],R=r[3],S=r[4],w=r[5],M=r[6],L=r[7],C=r[8],P=r[9],A=r[10],B=r[11],D=r[12],I=r[13],U=r[14],F=r[15];return i[0]=s*E+u*T+l*x+m*R,i[1]=o*E+c*T+p*x+_*R,i[2]=a*E+d*T+v*x+b*R,i[3]=h*E+f*T+g*x+y*R,i[4]=s*S+u*w+l*M+m*L,i[5]=o*S+c*w+p*M+_*L,i[6]=a*S+d*w+v*M+b*L,i[7]=h*S+f*w+g*M+y*L,i[8]=s*C+u*P+l*A+m*B,i[9]=o*C+c*P+p*A+_*B,i[10]=a*C+d*P+v*A+b*B,i[11]=h*C+f*P+g*A+y*B,i[12]=s*D+u*I+l*U+m*F,i[13]=o*D+c*I+p*U+_*F,i[14]=a*D+d*I+v*U+b*F,i[15]=h*D+f*I+g*U+y*F,this},mulSelf:function(e){return this.mul(e,this)},transformNorm:function(e){var t=this.elements,i=e[0],n=e[1],r=e[2];return e[0]=t[0]*i+t[4]*n+t[8]*r,e[1]=t[1]*i+t[5]*n+t[9]*r,e[2]=t[2]*i+t[6]*n+t[10]*r,e},transformPos:function(e){var t=this.elements,i=e[0],n=e[1],r=e[2];return e[0]=t[0]*i+t[4]*n+t[8]*r+t[12],e[1]=t[1]*i+t[5]*n+t[9]*r+t[13],e[2]=t[2]*i+t[6]*n+t[10]*r+t[14],e},transform:function(e){var t=this.elements,i=e[0],n=e[1],r=e[2],s=e[3];return e[0]=t[0]*i+t[4]*n+t[8]*r+t[12]*s,e[1]=t[1]*i+t[5]*n+t[9]*r+t[13]*s,e[2]=t[2]*i+t[6]*n+t[10]*r+t[14]*s,e[3]=t[3]*i+t[7]*n+t[11]*r+t[15]*s,e}};var s=new t;return t}),define("Math/Math",[],function(){"use strict";Math.clamp=function(e,t,i){return t>e?t:e>i?i:e},Math.degToRad=function(e){return.01745329251994*e},Math.radToDeg=function(e){return 57.2957795130823*e},Math.nextPowerOfTwo=function(e){for(var t=1;e>t;)t=2*t;return t},Math.isPowerOfTwo=function(e){return Math.nextPowerOfTwo(e)===e}}),define("Components/Camera",["Core/EventHandler","Math/Mat4","Math/Vec3","Math/Math"],function(e,t,i){"use strict";function n(e,n){this.position=new i(0,0,1),this.direction=new i(0,0,-1),this.up=new i(0,1,0),this.side=new i(1,0,0),this.fovy=Math.degToRad(35),this.aspect=e.canvas.width/e.canvas.height,this.near=1,this.far=1e3,this.viewMatrix=new t,this.inverseViewMatrix=new t,this.projectionMatrix=new t,this.inverseProjectionMatrix=new t,this.viewProjectionMatrix=new t,this.inverseViewProjectionMatrix=new t,this._listenerID=-1,this.init(e,n)}return n.type="Camera",n.prototype={type:n.type,init:function(e,t){t=t||{},this.near=t.near||this.near,this.far=t.far||this.far,this.fovy=t.fovy||this.fovy,this.aspect=t.aspect||this.aspect,this.setProjection(this.fovy,this.aspect,this.near,this.far)},attach:function(e,t){return this._listenerID=e.eventHandler.addEventListener(this,this._processEvent),!0},detach:function(e,t){e.eventHandler.removeEventListener(this._listenerID)},setLookAt:function(e,t,i){i=i||[0,1,0],this.position.copy(e),this.direction.copy(t).subSelf(e).normalize(),this.up.copy(i).normalize(),this.side.cross(this.up,this.direction),this.viewMatrix.lookAt(e,t,i),this.viewProjectionMatrix.mul(this.projectionMatrix,this.viewMatrix),this.inverseViewMatrix.inverse(this.viewMatrix),this.inverseViewProjectionMatrix.inverse(this.viewProjectionMatrix)},setProjection:function(e,t,i,n){this.fovy=e,this.aspect=t,this.near=i,this.far=n,this.projectionMatrix.projection(this.fovy,this.aspect,this.near,this.far),this.viewProjectionMatrix.mul(this.projectionMatrix,this.viewMatrix),this.inverseProjectionMatrix.inverse(this.projectionMatrix),this.inverseViewProjectionMatrix.inverse(this.viewProjectionMatrix)},setNear:function(e){this.setProjection(this.fovy,this.aspect,e,this.far)},setFar:function(e){this.setProjection(this.fovy,this.aspect,this.near,e)},setAspect:function(e){this.setProjection(this.fovy,e,this.near,this.far)},setFovy:function(e){this.setProjection(e,this.aspect,this.near,this.far)},project:function(e){var t=this.projectionMatrix.transform([e[0],e[1],e[2],1]);return e.set(t[0]/t[3],t[1]/t[3],t[2]/t[3]),e},unProject:function(e){var t=this.inverseProjectionMatrix.transform([e[0],e[1],e[2],1]);return e.set(t[0]/t[3],t[1]/t[3],t[2]/t[3]),e},_processEvent:function(t){switch(t.type){case e.EVENTS.VIEWPORT:this.setAspect(t.width/t.height)}return!1}},n}),define("Components/Transformation",["Math/Mat4"],function(e){"use strict";function t(t,i){this.relativeMatrix=i&&i.matrix?new e(i.matrix):new e,this.worldMatrix=new e,this.normalMatrix=new e}return t.type="Transformation",t.prototype={type:t.type,init:function(e,t){return this},deinit:function(e){},updateMatrix:function(e){e?this.worldMatrix.mul(e.worldMatrix,this.relativeMatrix):this.worldMatrix.copy(this.relativeMatrix),this.normalMatrix.removeScale(this.worldMatrix)},setPosition:function(e){var t=this.relativeMatrix.elements;return t[12]=e[0],t[13]=e[1],t[14]=e[2],this},setRotation:function(e){return this.relativeMatrix.rotationXYZ(e[0],e[1],e[2]),this}},t}),define("Components/Light",["Components/Transformation","Math/Vec4","Math/Vec3","Math/Vec2"],function(e,t,i,n){"use strict";function r(e,r){this.lightType=s,this.diffuse=new t(1,1,1,1),this.position=new i(0,0,0),this.direction=new i(1,1,1),this.worldPosition=new i,this.worldDirection=new i,this.inverseWorldDirection=new i,this.radius=new n,this.castShadow=!1,this.shadowSize=512,this.shadowColor=new t(0,0,0,1),this._worldMatrix=void 0,this.init(e,r)}var s=0,o=1,a=2;return r.type="Light",r.DIRECTIONAL=s,r.POINT=o,r.SPOT=a,r.prototype={type:r.type,init:function(e,t){t=t||{},this.lightType=t.lightType||this.lightType,this.diffuse.copy(t.diffuse||this.diffuse),this.setPosition(t.position||this.position),this.setDirection(t.direction||this.direction),this.radius.copy(t.radius||this.radius),void 0!==t.shadow&&(this.castShadow=!0,this.shadowSize=t.shadow.size||this.shadowSize,this.shadowColor.copy(t.shadow.color||this.shadowColor))},deinit:function(e){},attach:function(t,i){var n=i.getComponent(e.type);return void 0!==n&&(this._worldMatrix=n.worldMatrix),!0},notification:function(t,i,n,r){r.type===e.type&&("ATTACHED"==n?this._worldMatrix=r.worldMatrix:"DETACHED"==n&&(this._worldMatrix=void 0))},update:function(){switch(this.lightType){case s:this.setDirection(this.direction);break;case o:this.setPosition(this.position);break;case a:this.setPosition(this.position),this.setDirection(this.direction)}},setPosition:function(e){return this.position.copy(e),this.worldPosition.copy(e),void 0!==this._worldMatrix&&this._worldMatrix.transformPos(this.worldPosition),this},setDirection:function(e){return this.direction.copy(e),this.worldDirection.copy(e).normalize(),void 0!==this._worldMatrix&&(this._worldMatrix.transformNorm(this.worldDirection),this.worldDirection.normalize()),this.inverseWorldDirection.negate(this.worldDirection),this}},r}),define("States/StateBlock",[],function(){"use strict";function e(e){this.states=[],this.backupStates=[]}return e.prototype={add:function(e){this.states.push(e),this.backupStates.push(e.backup())},set:function(e){this.states.forEach(function(t){t.set(e)})},backup:function(){for(var e=0;e<this.states.length;++e)this.states[e].backup(this.backupStates[e])},restore:function(e){this.backupStates.forEach(function(t){t.set(e)})}},e}),define("Renderer/Renderable",["Math/Mat4","Math/Vec4","States/StateBlock"],function(e,t,i){"use strict";function n(){this.primitiveType=WebGLRenderingContext.TRIANGLES,this.vertexBuffer=void 0,this.indexBuffer=void 0,this.shader=void 0,this.textures=[],this.count=0,this.offset=0,this.states=new i,this.diffuse=new t,this.ambient=new t,this.specular=new t,this.specularHardness=10,this.specularPower=.8,this.worldMatrix=new e,this.normalMatrix=new e}return n.prototype={deinit:function(){void 0!==this.vertexBuffer&&this.vertexBuffer.release(),void 0!==this.indexBuffer&&this.indexBuffer.release(),void 0!==this.shader&&this.shader.release();for(var e=0;e<this.textures.length;++e)void 0!==this.textures[e]&&this.textures[e].release();this.vertexBuffer=void 0,this.indexBuffer=void 0,this.shader=void 0,this.textures.length=0}},n}),define("Components/Mesh",["Renderer/Renderable","Components/Transformation","Math/Mat4"],function(e,t,i){"use strict";function n(e,t){this.renderables=[],this.init(e,t)}return n.type="Mesh",n.prototype={type:n.type,init:function(t,i){i=i||{};var n=i.subsets||[],r=null;n.forEach(function(t){if(r=new e,r.vertexBuffer=i.vb.clone(),r.indexBuffer=i.ib.clone(),void 0!==i.shader&&(r.shader=i.shader.clone()),r.count=t.count,r.primitiveType=t.primitiveType||r.primitiveType,r.offset=t.offset||r.offset,r.diffuse.copy(t.diffuse||r.diffuse),r.specular.copy(t.specular||r.specular),r.ambient.copy(t.ambient||r.ambient),r.specularHardness=t.specularHardness||r.specularHardness,r.specularPower=t.specularPower||r.specularPower,t.textures)for(var n=0;n<t.textures.length;++n)r.textures.push(t.textures[n].clone());this.renderables.push(r)},this),i.autoReleaseBuffers===!0&&(i.vb.release(),i.ib.release())},deinit:function(e){for(var t=0;t<this.renderables.length;++t)this.renderables[t].deinit()},attach:function(e,i){var n=void 0,r=void 0,s=i.getComponent(t.type);return void 0!==s&&(n=s.worldMatrix,r=s.normalMatrix),this.setMatrices(n,r),!0},notification:function(e,i,n,r){r.type===t.type&&("ATTACHED"==n?this.setMatrices(r.worldMatrix,r.normalMatrix):"DETACHED"==n&&this.setMatrices(void 0,void 0))},setMatrices:function(e,t){for(var n=0;n<this.renderables.length;++n)this.renderables[n].worldMatrix=e||new i,this.renderables[n].normalMatrix=t||new i},setShader:function(e){this.renderables.forEach(function(t){t.shader&&t.shader.release(),t.shader=e.clone()})}},n}),define("Components/CameraController",["Core/EventHandler","Components/Camera","Math/Vec3","Math/Math"],function(e,t,i){"use strict";function n(e,t){this.rotateSensitivity=1,this.zoomSensitivity=1,this.panSensitivity=1,this._camera=null,this._position=new i(0,0,1),this._target=new i,this._mouseDownPosition=null,this._currentButton=-1,this._listenerID=-1,this._snapshot={position:new i(this._position),target:new i(this._target),spherical:new i},this._v0=new i,this._v1=new i,this._v2=new i,this.init(e,t)}return n.type="CameraController",n.prototype={type:n.type,attach:function(e,i){return this._listenerID=e.eventHandler.addEventListener(this,this._processEvent),this._camera=i.getComponent(t.type),this._camera&&this._camera.setLookAt(this._position,this._target),!0},detach:function(e,t){e.eventHandler.removeEventListener(this._listenerID),this._camera=null},notification:function(e,i,n,r){r.type===t.type&&("ATTACHED"===n?(this._camera=r,this._camera.setLookAt(this._position,this._target)):"DETACHED"===n&&(this._camera=void 0))},init:function(e,t){t=t||{},this.rotateSensitivity=t.rotateSensitivity||this.rotateSensitivity,this.zoomSensitivity=t.zoomSensitivity||this.zoomSensitivity,this.panSensitivity=t.panSensitivity||this.panSensitivity,this._position.copy(t.position||this._position),this._target.copy(t.target||this._target)},deinit:function(e){},_rotate:function(e,t){var i=.5,n=.01,r=n,s=Math.PI-n,o=this._v0.copy(this._snapshot.spherical);return e*=i*this.rotateSensitivity,t*=i*this.rotateSensitivity,o[1]=this._snapshot.spherical[1]-Math.degToRad(t),o[2]=this._snapshot.spherical[2]+Math.degToRad(e),o[1]=Math.clamp(o[1],r,s),this._position.add(this._target,o.toCartesian()),this},_zoom:function(e,t){var i=10,n=.04,r=this._v0.copy(this._snapshot.spherical),s=(e+t)*n*this.zoomSensitivity;return r[0]=Math.exp(Math.log(this._snapshot.spherical[0])-s/i),r[0]<.1&&(r[0]=.1),this._position.add(this._target,r.toCartesian()),this},_pan:function(e,t){var i=.002,n=this._v0.copy(this._snapshot.spherical),r=i*this.panSensitivity*n[0],s=e*r,o=t*r,a=this._camera.viewMatrix.elements,h=this._v1.set(a[0],a[4],a[8]).mulScalarSelf(s),u=this._v2.set(a[1],a[5],a[9]).mulScalarSelf(o);return this._target.sub(this._snapshot.target,h).addSelf(u),this._position.add(this._target,n.toCartesian()),this},update:function(){return null!==this._camera&&this._camera.setLookAt(this._position,this._target,[0,1,0]),this},_processEvent:function(t){if(null!==this._camera){switch(t.type){case e.EVENTS.MOUSEDOWN:return this._mouseDownPosition=[t.x,t.y],this._currentButton=t.button,this._snapshot.position.copy(this._position),this._snapshot.target.copy(this._target),this._snapshot.spherical.sub(this._position,this._target).toSpherical(),!0;case e.EVENTS.MOUSEUP:return-1!==this._currentButton?(this._currentButton=-1,!0):!1;case e.EVENTS.MOUSEMOVE:if(-1===this._currentButton)return!1;var i=t.x-this._mouseDownPosition[0],n=t.y-this._mouseDownPosition[1];switch(this._currentButton){case e.MOUSEBUTTONS.LEFT:this._rotate(i,n);break;case e.MOUSEBUTTONS.MIDDLE:this._pan(i,n);break;case e.MOUSEBUTTONS.RIGHT:this._zoom(i,n);break;default:return!1}return!0}return!1}}},n}),define("Utils/UID",[],function(){"use strict";var e={"default":0};return{newId:function(t){
return t?(e.hasOwnProperty(t)||(e[t]=0),e[t]++):e["default"]++}}}),define("Utils/Array",[],function(){"use strict";Array.prototype.remove=function(e){for(var t=this.indexOf(e);-1!==t;)this.splice(t,1),t=this.indexOf(e);return this},Array.prototype.removeIf=function(e){for(var t=this.length;--t>=0;)e(this[t])&&this.splice(t,1);return this},Array.prototype.contains=function(e){return-1!==this.indexOf(e)},Array.prototype.clear=function(){return this.length=0,this},Array.prototype.findIf=function(e,t){if(t){for(var i=[],n=0;n<this.length;++n)e(this[n])&&i.push(this[n]);return i}for(var n=0;n<this.length;++n)if(e(this[n]))return this[n]}}),define("Core/Node",["Utils/UID","Utils/Array"],function(e){"use strict";function t(t,i){this.name=i||"_",this.id=e.newId("node"),this.parent=void 0,this.children=[],this.components=[],this.engine=t}return t.prototype={deinit:function(){for(var e=this.components.length-1;e>=0;--e)this.removeComponent(this.components[e],!0);for(var e=this.children.length-1;e>=0;--e)this.removeChild(this.children[e],!0)},addChild:function(e){this.children.remove(e),this.children.push(e),e.parent=this},removeChild:function(e,t){this.children.remove(e),e.parent=void 0,t&&e.deinit()},addComponent:function(e){(void 0===e.attach||e.attach(this.engine,this))&&(this.components.push(e),this.components.forEach(function(t){t.notification&&t!==e&&t.notification(this.engine,this,"ATTACHED",e)},this))},removeComponent:function(e,t){void 0!==e.detach&&e.detach(this.engine,this),this.components.remove(e),this.components.forEach(function(t){t.notification&&t.notification(this.engine,this,"DETACHED",e)},this),t&&e.deinit&&e.deinit(this.engine)},getComponent:function(e){for(var t=this.components.length-1;t>=0;--t)if(this.components[t].type===e)return this.components[t]},find:function(e,t,i){var n=[];return this.walk({pre:function(r){return r[e]===t?(n.push(r),i):void 0}}),i?0===n.length?void 0:n[0]:n},walk:function(e){var t=e.pre,i=e.post;if(!t||!t(this)){for(var n=0,r=this.children.length,s=this;n!=r||s!=this;)if(n==r){if(i&&i(s))return;n=s.parent.children.indexOf(s)+1,s=s.parent,r=s.children.length}else{if(s=s.children[n],t&&t(s))return;n=0,r=s.children.length}i&&i(this)}}},t}),define("Resources/ResourceHandle",[],function(){"use strict";function e(e){this.resourcePointer=e,this.resourcePointer.grab()}return e.prototype={release:function(){this.resourcePointer.release(),delete this.resourcePointer},clone:function(){return new e(this.resourcePointer)},getResource:function(){return this.resourcePointer.resource}},e}),define("Utils/GLUtils",[],function(){"use strict";var e={GL_STREAM_DRAW:WebGLRenderingContext.STREAM_DRAW,GL_STATIC_DRAW:WebGLRenderingContext.STATIC_DRAW,GL_DYNAMIC_DRAW:WebGLRenderingContext.DYNAMIC_DRAW,GL_BYTE:WebGLRenderingContext.BYTE,GL_UNSIGNED_BYTE:WebGLRenderingContext.UNSIGNED_BYTE,GL_SHORT:WebGLRenderingContext.SHORT,GL_UNSIGNED_SHORT:WebGLRenderingContext.UNSIGNED_SHORT,GL_INT:WebGLRenderingContext.INT,GL_UNSIGNED_INT:WebGLRenderingContext.UNSIGNED_INT,GL_FLOAT:WebGLRenderingContext.FLOAT,STREAM_DRAW:WebGLRenderingContext.STREAM_DRAW,STATIC_DRAW:WebGLRenderingContext.STATIC_DRAW,DYNAMIC_DRAW:WebGLRenderingContext.DYNAMIC_DRAW,BYTE:WebGLRenderingContext.BYTE,UNSIGNED_BYTE:WebGLRenderingContext.UNSIGNED_BYTE,SHORT:WebGLRenderingContext.SHORT,UNSIGNED_SHORT:WebGLRenderingContext.UNSIGNED_SHORT,INT:WebGLRenderingContext.INT,UNSIGNED_INT:WebGLRenderingContext.UNSIGNED_INT,FLOAT:WebGLRenderingContext.FLOAT};return{stringToGLenum:function(t){if("string"==typeof t){var i=e[t];if(void 0!==i)return i}else if("number"==typeof t)return t;throw"stringToGLenum - invalid parameter value"},getTypeSize:function(e){switch(e){case WebGLRenderingContext.BYTE:return Int8Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.SHORT:return Int16Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.INT:return Int32Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case WebGLRenderingContext.FLOAT:return Float32Array.BYTES_PER_ELEMENT}throw"getTypeSize - unknown type"},createTypedArray:function(e,t,i){switch(e){case WebGLRenderingContext.BYTE:return new Int8Array(t,i);case WebGLRenderingContext.UNSIGNED_BYTE:return new Uint8Array(t,i);case WebGLRenderingContext.SHORT:return new Int16Array(t,i);case WebGLRenderingContext.UNSIGNED_SHORT:return new Uint16Array(t,i);case WebGLRenderingContext.INT:return new Int32Array(t,i);case WebGLRenderingContext.UNSIGNED_INT:return new Uint32Array(t,i);case WebGLRenderingContext.FLOAT:return new Float32Array(t,i)}throw"createTypedArray - unknown type"}}}),define("Resources/VertexBuffer",["Utils/GLUtils"],function(e){"use strict";function t(e,t){this.buffer=void 0,this.streams={},this.vertexSize=0,this.size=0,this.usage=e.STATIC_DRAW,this.init(e,t)}return t.prototype={init:function(t,i){if(i=i||{},i.streams=i.streams||[],this.usage=e.stringToGLenum(i.usage||this.usage),this.vertexSize=0,i.streams.forEach(function(i){i.type=e.stringToGLenum(i.type),i.offset=this.vertexSize,i.normalized=i.type===t.UNSIGNED_BYTE||i.type===t.BYTE?!0:!1,this.vertexSize+=e.getTypeSize(i.type)*i.size,this.streams[i.semantic]={type:i.type,size:i.size,offset:i.offset,normalized:i.normalized}},this),i.data)this.setData(t,i.data);else if(i.size)this.setData(t,i.size);else if(i.streams.length>0){var n={},r=0;i.streams.forEach(function(e){void 0!==e.data&&(r+=1,n[e.semantic]=e.data)},this),r===i.streams.length&&this.setData(t,n)}},deinit:function(e){void 0!==this.buffer&&e.deleteBuffer(this.buffer)},isValid:function(){return void 0!==this.buffer},setData:function(t,i){if(void 0===i.byteLength)if("object"==typeof i){var n=i,r=-1;for(var s in this.streams){if(n.hasOwnProperty(s)===!1)throw"missing stream";if(-1===r&&(r=n[s].length/this.streams[s].size),n[s].length/this.streams[s].size!==r)throw"incorrect number of elements"}if(0===r)return;i=new ArrayBuffer(this.vertexSize*r);for(var s in this.streams)for(var o=this.streams[s],a=e.createTypedArray(o.type,i,o.offset),h=this.vertexSize/e.getTypeSize(o.type),u=n[s],c=0;r>c;++c)for(var d=0;d<o.size;++d)a[c*h+d]=u[c*o.size+d];this.size=i.byteLength/this.vertexSize}else"number"==typeof i&&(this.size=i);else this.size=i.byteLength/this.vertexSize;void 0===this.buffer&&(this.buffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,i,this.usage),t.bindBuffer(t.ARRAY_BUFFER,null)}},t}),define("Resources/IndexBuffer",["Utils/GLUtils"],function(e){"use strict";function t(e,t){this.buffer=void 0,this.size=0,this.usage=e.STATIC_DRAW,this.indexType=e.UNSIGNED_SHORT,this.init(e,t)}return t.prototype={init:function(t,i){i=i||{},this.usage=e.stringToGLenum(i.usage||this.usage),this.indexType=e.stringToGLenum(i.type||this.indexType),this.indexSize=e.getTypeSize(this.indexType),i.data?this.setData(t,i.data):void 0!==i.size&&this.setData(t,i.size)},deinit:function(e){void 0!==this.buffer&&e.deleteBuffer(this.buffer)},isValid:function(){return void 0!==this.buffer},setData:function(t,i){void 0!==i.length?(this.size=i.length,i=e.createTypedArray(this.indexType,i)):void 0!==i.byteLength?this.size=i.byteLength/this.indexSize:this.size=i,void 0===this.buffer&&(this.buffer=t.createBuffer()),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,i,this.usage),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}},t}),define("Resources/Texture",[],function(){"use strict";function e(e,t){this.texture=void 0,this.width=0,this.height=0,this.target=WebGLRenderingContext.TEXTURE_2D,this.init(e,t)}return e.prototype={init:function(e,t){t=t||{},this.width=t.width||t.size||this.width,this.height=t.height||t.size||this.height,this.target=t.target||this.target,this.format=t.format||e.RGBA,this.internalFormat=t.internalFormat||e.RGBA,this.type=t.type||e.UNSIGNED_BYTE,this.minFilter=t.filter||t.minFilter||e.LINEAR_MIPMAP_LINEAR,this.magFilter=t.filter||t.magFilter||e.LINEAR,this.wrapS=t.wrap||t.wrapS||e.REPEAT,this.wrapT=t.wrap||t.wrapT||e.REPEAT,(Math.isPowerOfTwo(this.width)===!1||Math.isPowerOfTwo(this.height)===!1||t.mipmap===!1)&&(t.mipmap=!1,this.wrapS=e.CLAMP_TO_EDGE,this.wrapT=e.CLAMP_TO_EDGE,this.minFilter=e.LINEAR),this.texture=e.createTexture(),e.bindTexture(this.target,this.texture);var i=t.data;if(this.target===e.TEXTURE_2D)this.setData(e,this.target,i);else if(this.target===e.TEXTURE_CUBE_MAP)for(var n=[e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z],r=0;6>r;++r)this.setData(e,n[r],i?i[r]:void 0);t.mipmap!==!1&&e.generateMipmap(this.target),e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,this.minFilter),e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,this.magFilter),e.texParameteri(this.target,e.TEXTURE_WRAP_S,this.wrapS),e.texParameteri(this.target,e.TEXTURE_WRAP_T,this.wrapT),this.minFilter!==e.NEAREST&&e.texParameterf(this.target,e.TEXTURE_MAX_ANISOTROPY_EXT,e.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),e.bindTexture(this.target,null)},deinit:function(e){this.texture&&(e.deleteTexture(this.texture),delete this.texture)},isValid:function(){return void 0!==this.texture},setData:function(e,t,i){void 0===i||void 0!==i.length||void 0!==i.byteLength?(i=void 0===i?null:void 0===i.length?i:new Uint8Array(i),e.texImage2D(t,0,this.internalFormat,this.width,this.height,0,this.format,this.type,i)):e.texImage2D(t,0,this.internalFormat,this.format,this.type,i)}},e}),define("Resources/Uniforms",["Math/Mat4","Math/Vec4","Math/Vec3","Math/Vec2"],function(e,t,i,n){"use strict";var r={engine:void 0,resourceManager:void 0,renderer:void 0,renderLayer:void 0,renderable:void 0,camera:void 0,lights:void 0},s=function(e){r.engine=e,r.resourceManager=e.resourceManager,r.renderer=e.renderer,r.renderLayer=e.renderer.currentRenderLayer,r.renderTarget=e.renderer.currentRenderLayer.renderTarget,r.renderable=e.renderer.currentRenderable,r.lights=e.renderer.currentRenderLayer.lights,r.camera=e.renderer.currentRenderLayer.camera},o={"float":function(e,t,i){i.uniform1f(e,t)},vec2:function(e,t,i){i.uniform2fv(e,t)},vec3:function(e,t,i){i.uniform3fv(e,t)},vec4:function(e,t,i){i.uniform4fv(e,t)},mat4:function(e,t,i){i.uniformMatrix4fv(e,!1,t)},texture:function(e,t,i){i.uniform1i(e,t)}},a={"float":function(e,t){return e.value=t.value,e},vec2:function(e,t){return e.value=new Float32Array(t.value),e},vec3:function(e,t){return e.value=new Float32Array(t.value),e},vec4:function(e,t){return e.value=new Float32Array(t.value),e},mat4:function(e,t){return e.value=new Float32Array(t.value),e},texture:function(e,t){return e.index=t.value,e}},h={time:function(e,t){return e.set=function(e,t){t.uniform1f(this.location,e.engine.time)}.bind(e,r),e},world:function(e,t){return e.set=function(e,t){t.uniformMatrix4fv(this.location,!1,e.renderable.worldMatrix.elements)}.bind(e,r),e},normal:function(e,t){return e.set=function(e,t){t.uniformMatrix4fv(this.location,!1,e.renderable.normalMatrix.elements)}.bind(e,r),e},view:function(e,t){return e.set=function(e,t){t.uniformMatrix4fv(this.location,!1,e.camera.viewMatrix.elements)}.bind(e,r),e},inverseView:function(e,t){return e.set=function(e,t){t.uniformMatrix4fv(this.location,!1,e.camera.inverseViewMatrix.elements)}.bind(e,r),e},projection:function(e,t){return e.set=function(e,t){t.uniformMatrix4fv(this.location,!1,e.camera.projectionMatrix.elements)}.bind(e,r),e},inverseProjection:function(e,t){return e.set=function(e,t){t.uniformMatrix4fv(this.location,!1,e.camera.inverseProjectionMatrix.elements)}.bind(e,r),e},viewProjection:function(e,t){return e.set=function(e,t){t.uniformMatrix4fv(this.location,!1,e.camera.viewProjectionMatrix.elements)}.bind(e,r),e},inverseViewProjection:function(e,t){return e.set=function(e,t){t.uniformMatrix4fv(this.location,!1,e.camera.inverseViewProjectionMatrix.elements)}.bind(e,r),e},worldView:function(t,i){return t.value=new e,t.set=function(e,t){this.value.mul(e.camera.viewMatrix,e.renderable.worldMatrix),t.uniformMatrix4fv(this.location,!1,this.value.elements)}.bind(t,r),t},worldViewProjection:function(t,i){return t.value=new e,t.set=function(e,t){this.value.mul(e.camera.viewProjectionMatrix,e.renderable.worldMatrix),t.uniformMatrix4fv(this.location,!1,this.value.elements)}.bind(t,r),t},normalView:function(t,i){return t.value=new e,t.set=function(e,t){this.value.mul(e.camera.viewMatrix,e.renderable.normalMatrix),t.uniformMatrix4fv(this.location,!1,this.value.elements)}.bind(t,r),t},normalViewProjection:function(t,i){return t.value=new e,t.set=function(e,t){this.value.mul(e.camera.viewProjectionMatrix,e.renderable.normalMatrix),t.uniformMatrix4fv(this.location,!1,this.value.elements)}.bind(t,r),t},cameraPosition:function(e,t){return e.set=function(e,t){t.uniform3fv(this.location,e.camera.position.toFloatArray())}.bind(e,r),e},cameraDirection:function(e,t){return e.set=function(e,t){t.uniform3fv(this.location,e.camera.direction.toFloatArray())}.bind(e,r),e},cameraUp:function(e,t){return e.set=function(e,t){t.uniform3fv(this.location,e.camera.up)}.bind(e,r),e},cameraSide:function(e,t){return e.set=function(e,t){t.uniform3fv(this.location,e.camera.side)}.bind(e,r),e},cameraNear:function(e,t){return e.set=function(e,t){t.uniform1f(this.location,e.camera.near)}.bind(e,r),e},cameraFar:function(e,t){return e.set=function(e,t){t.uniform1f(this.location,e.camera.far)}.bind(e,r),e},cameraFOVY:function(e,t){return e.set=function(e,t){t.uniform1f(this.location,e.camera.fovy)}.bind(e,r),e},cameraAspect:function(e,t){return e.set=function(e,t){t.uniform1f(this.location,e.camera.aspect)}.bind(e,r),e},resolution:function(e,t){return e.set=function(e,t){t.uniform2f(this.location,e.renderTarget.width,e.renderTarget.height)}.bind(e,r),e},linearizeDepth:function(e,t){return e.value=new Float32Array([0,0,0]),e.set=function(e,t){var i=e.camera.near,n=e.camera.far;this.value[0]=2*i,this.value[1]=i-n,this.value[2]=i+n,t.uniform3fv(this.location,this.value)}.bind(e,r),e},lightDiffuse:function(e,t){return e.index=t.index,e.set=function(e,t){this.index<e.lights.length&&t.uniform4fv(this.location,e.lights[this.index].diffuse.toFloatArray())}.bind(e,r),e},lightPosition:function(e,t){return e.index=t.index,e.set=function(e,t){this.index<e.lights.length&&t.uniform3fv(this.location,e.lights[this.index].worldPosition.toFloatArray())}.bind(e,r),e},lightDirection:function(e,t){return e.index=t.index,e.set=function(e,t){this.index<e.lights.length&&t.uniform3fv(this.location,e.lights[this.index].worldDirection.toFloatArray())}.bind(e,r),e},lightInverseDirection:function(e,t){return e.index=t.index,e.set=function(e,t){this.index<e.lights.length&&t.uniform3fv(this.location,e.lights[this.index].inverseWorldDirection.toFloatArray())}.bind(e,r),e},lightSpotRadius:function(e,t){return e.index=t.index,e.set=function(e,t){this.index<e.lights.length&&t.uniform2fv(this.location,e.lights[this.index].radius.toFloatArray())}.bind(e,r),e},materialDiffuse:function(e,t){return e.set=function(e,t){t.uniform4fv(this.location,e.renderable.diffuse.toFloatArray())}.bind(e,r),e},materialSpecular:function(e,t){return e.set=function(e,t){t.uniform4fv(this.location,e.renderable.specular.toFloatArray())}.bind(e,r),e},materialSpecularHardness:function(e,t){return e.set=function(e,t){t.uniform1f(this.location,e.renderable.specularHardness)}.bind(e,r),e},materialSpecularPower:function(e,t){return e.set=function(e,t){t.uniform1f(this.location,e.renderable.specularPower)}.bind(e,r),e},materialAmbient:function(e,t){return e.set=function(e,t){t.uniform4fv(this.location,e.renderable.ambient.toFloatArray())}.bind(e,r),e},texture:function(e,t){void 0!==t.index?(e.index=t.index,e.set=function(e){e.uniform1i(this.location,this.index)}.bind(e)):void 0!==t.value&&(e.value=t.value,e.set=function(e,t){t.uniform1i(this.location,e.resourceManager.setTexture(this.value))}.bind(e,r))},textureSize:function(e,t){void 0!==t.index?(e.size=new Float32Array([0,0]),e.index=t.index,e.set=function(e,t){var i=e.renderable.textures[this.index].getResource();this.size[0]=i.width,this.size[1]=i.height,t.uniform2fv(this.location,this.size)}.bind(e,r)):void 0!==t.value&&(e.size=new Float32Array([0,0]),e.value=t.value,e.set=function(e){var t=this.value.getResource();this.size[0]=t.width,this.size[1]=t.height,e.uniform2fv(this.location,this.size)}.bind(e))}},u=function(e,t,i){return void 0!==i.name?{location:e.getUniformLocation(t,i.name)}:void 0},c=function(e,t,i){var n=u(e,t,i);if(void 0!==n){if(void 0!==i.reference){var r=h[i.reference];if(void 0===r)return;r(n,i)}else{if(void 0===i.type)return;var s=o[i.type];if(void 0===s)return;if(void 0!==i.value){var r=a[i.type];if(void 0===r)return;r(n,i),n["static"]=!0,n.set=s.bind(n,n.location,n.value)}else void 0!==i.object&&(n.object=i.object,n.attribute=i.attribute,n.setter=s,n.set=function(e){this.setter(this.location,this.object[this.attribute],e)}.bind(n))}return n}};return{create:c,updateCache:s}}),define("Resources/Shader",["./Uniforms"],function(e){"use strict";function t(e,t){this.program=void 0,this.vs=void 0,this.fs=void 0,this.attributes={},this.uniforms=[],this.init(e,t)}return t.prototype={init:function(t,i){if(i=i||{},void 0!==i.vs&&void 0!==i.fs&&(this.vs=this.compile(t,i,"vs"),this.fs=this.compile(t,i,"fs"),void 0!==this.vs&&void 0!==this.fs)){if(this.program=t.createProgram(),t.attachShader(this.program,this.vs),t.attachShader(this.program,this.fs),t.linkProgram(this.program),t.getProgramParameter(this.program,t.LINK_STATUS)===!1)return console.log("Failed to link shader program: "+t.getProgramInfoLog(this.program)),void this.deinit(t);(i.attributes||[]).forEach(function(e){this.attributes[e.semantic]=t.getAttribLocation(this.program,e.name)},this),(i.uniforms||[]).forEach(function(i){i=e.create(t,this.program,i),void 0!==i&&this.uniforms.push(i)},this)}},deinit:function(e){this.program&&e.deleteProgram(this.program),this.vs&&e.deleteShader(this.vs),this.fs&&e.deleteShader(this.fs)},addUniform:function(e){this.uniforms.push(e)},isValid:function(){return void 0!==this.program},compile:function(e,t,i){var n=t[i];"string"!=typeof n&&(n=n.join("\n")),(t.defines||[]).forEach(function(e){n="#define "+e+"\n"+n});var r=e.createShader({vs:e.VERTEX_SHADER,fs:e.FRAGMENT_SHADER}[i]);if(e.shaderSource(r,n),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)!==!1)return r}},t}),define("Resources/ResourceManager",["./ResourceHandle","./VertexBuffer","./IndexBuffer","./Texture","./Shader"],function(e,t,i,n,r){"use strict";function s(e,t){this.resource=e,this.releaseCallback=t,this.refCount=0}function o(e){this.engine=e,this.resources=[],this.currentVertexBuffer=void 0,this.currentIndexBuffer=void 0,this.currentShader=void 0,this.currentTextures=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0]}return s.prototype={grab:function(){this.refCount+=1},release:function(){this.refCount-=1,this.refCount<=0&&this.releaseCallback()}},o.SHADER=0,o.VERTEX_BUFFER=1,o.INDEX_BUFFER=2,o.TEXTURE=3,o.prototype={createShader:function(e){return this.create(o.SHADER,e)},createTexture:function(e){return this.create(o.TEXTURE,e)},createVertexBuffer:function(e){return this.create(o.VERTEX_BUFFER,e)},createIndexBuffer:function(e){return this.create(o.INDEX_BUFFER,e)},create:function(s,a){var h=void 0,u=this.engine.gl,a=a||{};switch(s){case o.VERTEX_BUFFER:if("string"==typeof a.data){var c=a.data;delete a.data,h=this.createResourcePointer(new t(u,a)),this.engine.fileSystem.loadBinary(c,function(e){h.resource.setData(u,e.content)}.bind(this))}else h=this.createResourcePointer(new t(u,a));break;case o.INDEX_BUFFER:if("string"==typeof a.data){var c=a.data;delete a.data,h=this.createResourcePointer(new i(u,a)),this.engine.fileSystem.loadBinary(c,function(e){h.resource.setData(u,e.content)}.bind(this))}else h=this.createResourcePointer(new i(u,a));break;case o.SHADER:void 0!==a.vsFile||void 0!==a.fsFile?(h=this.createResourcePointer(this.getLoadingShader()),this.engine.fileSystem.loadMultiple([{url:a.vsFile,type:this.engine.fileSystem.TEXT},{url:a.fsFile,type:this.engine.fileSystem.TEXT}],function(e){a.vs=e[0].content,a.fs=e[1].content,h.resource=new r(u,a)}.bind(this),function(){h.resource=this.getInvalidShader()}.bind(this))):h=this.createResourcePointer(new r(u,a));break;case o.TEXTURE:if(void 0!==a.source){if("string"==typeof a.source)h=this.createResourcePointer(this.getLoadingTexture());else{if(void 0===a.source.length){h.resource=this.getNotFoundCubeTexture();break}h=this.createResourcePointer(this.getLoadingCubeTexture())}if("string"==typeof a.source)this.engine.fileSystem.loadImage(a.source,function(e){delete a.source,a.width=e.content.width,a.height=e.content.height,a.data=e.content,h.resource=new n(u,a)}.bind(this),function(){h.resource=this.getNotFoundTexture()}.bind(this));else{var d=[];if(a.source.forEach(function(e){d.push({url:e,type:this.engine.fileSystem.IMAGE})},this),6!==d.length){h.resource=this.getNotFoundCubeTexture();break}this.engine.fileSystem.loadMultiple(d,function(e){a.data=[],e.forEach(function(e,t){a.data[t]=e.content}),delete a.source,h.resource=new n(u,a)}.bind(this),function(){h.resource=this.getNotFoundCubeTexture()}.bind(this))}}else h=this.createResourcePointer(new n(u,a))}return h.resource.type=s,this.resources.push(h),new e(h)},update:function(e,t){var i=this.create(i.getResource().type,t),n=e.resourcePointer.resource;e.resourcePointer.resource=i.resourcePointer.getResource(),i.resourcePointer.resource=n,newresource.release()},createResourcePointer:function(e){var t=this,i=new s(e);return i.releaseCallback=function(){t.resources.remove(i),i.resource.deinit(t.engine.gl)},i},clearCurrentResources:function(){this.setVertexBuffer(void 0),this.setIndexBuffer(void 0),this.setShader(void 0);for(var e=0,t=this.currentTextures.length;t>e;++e)this.setTexture(void 0,e)},setVertexBuffer:function(e){e=void 0===e?void 0:e.getResource(),e!==this.currentVertexBuffer&&(this.currentVertexBuffer=e,this.engine.gl.bindBuffer(this.engine.gl.ARRAY_BUFFER,e?e.buffer:null),this.updateAttributes())},setIndexBuffer:function(e){e=void 0===e?void 0:e.getResource(),e!==this.currentIndexBuffer&&(this.currentIndexBuffer=e,this.engine.gl.bindBuffer(this.engine.gl.ELEMENT_ARRAY_BUFFER,e?e.buffer:null))},setShader:function(e){e=void 0===e?void 0:e.getResource();var t=this.engine.gl;if(e===this.currentShader)void 0!==e&&e.uniforms.forEach(function(e){e["static"]!==!0&&e.set(t)});else{if(this.currentShader=e,t.useProgram(e?e.program:null),void 0===e)return;e.uniforms.forEach(function(e){e.set(t)}),this.updateAttributes()}},setTexture:function(e,t){if(e=void 0===e?void 0:e.getResource(),void 0===t){for(var i=0,n=this.currentTextures.length;n>i;++i)if(void 0===this.currentTextures[i]){t=i;break}if(void 0===t)return}if(e!==this.currentTextures[t]){this.currentTextures[t]=e;var r=this.engine.gl;return r.activeTexture(r.TEXTURE0+t),void 0!==e?r.bindTexture(e.target,e.texture):r.bindTexture(r.TEXTURE_2D,null),t}},setTextures:function(e){for(var t=(this.engine.gl,0);t<e.length;++t)this.setTexture(e[t],t);for(var t=e.length;t<this.currentTextures.length;++t)this.setTexture(void 0,t)},updateAttributes:function(){var e=this.currentVertexBuffer,t=this.currentShader;if(void 0!==e&&void 0!==t){var i=void 0,n=void 0,r=this.engine.gl;for(var s in t.attributes)n=t.attributes[s],i=e.streams[s],void 0!==i?(r.enableVertexAttribArray(n),r.vertexAttribPointer(n,i.size,i.type,i.normalized,e.vertexSize,i.offset)):r.enableVertexAttribArray(n)}},getLoadingTexture:function(){return void 0===this.__loadingTexture&&(this.__loadingTexture=new n(this.engine.gl,{size:2,mipmap:!1,filter:this.engine.gl.NEAREST,data:[0,0,0,255,255,255,255,255,255,255,255,255,0,0,0,255]})),this.__loadingTexture},getLoadingCubeTexture:function(){return void 0===this.__loadingCubeTexture&&(this.__loadingCubeTexture=new n(this.engine.gl,{target:this.engine.gl.TEXTURE_CUBE_MAP,size:2,mipmap:!1,filter:this.engine.gl.NEAREST,data:[[0,0,0,255,255,255,255,255,255,255,255,255,0,0,0,255],[0,0,0,255,255,255,255,255,255,255,255,255,0,0,0,255],[0,0,0,255,255,255,255,255,255,255,255,255,0,0,0,255],[0,0,0,255,255,255,255,255,255,255,255,255,0,0,0,255],[0,0,0,255,255,255,255,255,255,255,255,255,0,0,0,255],[0,0,0,255,255,255,255,255,255,255,255,255,0,0,0,255]]})),this.__loadingCubeTexture},getLoadingShader:function(){return void 0===this.__loadingShader&&(this.__loadingShader=new r(this.engine.gl,{vs:["uniform mat4 uWorldViewProjection;","attribute mediump vec3 aPosition;","void main()","{","gl_Position = uWorldViewProjection * vec4(aPosition, 1);","}"],fs:["void main()","{","gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);","}"],attributes:[{semantic:"position",name:"aPosition"}],uniforms:[{name:"uWorldViewProjection",reference:"worldViewProjection"}]})),this.__loadingShader},getNotFoundTexture:function(){return new n(this.engine.gl,{size:2,mipmap:!1,filter:this.engine.gl.NEAREST,data:[255,0,0,255,255,255,255,255,255,255,255,255,255,0,0,255]})},getNotFoundCubeTexture:function(){return new n(this.engine.gl,{target:this.engine.gl.TEXTURE_CUBE_MAP,size:2,mipmap:!1,filter:this.engine.gl.NEAREST,data:[[255,0,0,255,255,255,255,255,255,255,255,255,255,0,0,255],[255,0,0,255,255,255,255,255,255,255,255,255,255,0,0,255],[255,0,0,255,255,255,255,255,255,255,255,255,255,0,0,255],[255,0,0,255,255,255,255,255,255,255,255,255,255,0,0,255],[255,0,0,255,255,255,255,255,255,255,255,255,255,0,0,255],[255,0,0,255,255,255,255,255,255,255,255,255,255,0,0,255]]})},getInvalidShader:function(){return new r(this.engine.gl,{vs:["uniform mat4 uWorldViewProjection;","attribute mediump vec3 aPosition;","void main()","{","gl_Position = uWorldViewProjection * vec4(aPosition, 1);","}"],fs:["void main()","{","gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);","}"],attributes:[{semantic:"position",name:"aPosition"}],uniforms:[{name:"uWorldViewProjection",reference:"worldViewProjection"}]})}},o}),define("Renderer/Renderer",["Resources/Uniforms"],function(e){"use strict";function t(e){this.currentRenderLayer=void 0,this.currentRenderable=void 0,this.layers=[],this.engine=e}return t.prototype={render:function(){var t=this.engine.stats.renderer;t.vertexCount=0,t.triangleCount=0,t.drawCalls=0;var i=this.engine.gl,n=this.engine.resourceManager;this.layers.forEach(function(r){this.currentRenderLayer=r,void 0!==r.renderTarget&&r.renderTarget.begin(i),r.states.backup(),r.states.set(i),r.renderables.forEach(function(s){switch(this.currentRenderable=s,e.updateCache(this.engine),n.setVertexBuffer(s.vertexBuffer),n.setIndexBuffer(s.indexBuffer),n.setTextures(s.textures),n.setShader(r.shader||s.shader),s.states.backup(),s.states.set(i),i.drawElements(s.primitiveType,s.count,n.currentIndexBuffer.indexType,s.offset),s.states.restore(i),t.drawCalls+=1,t.vertexCount+=n.currentVertexBuffer.size,s.primitiveType){case i.TRIANGLES:t.triangleCount+=s.count/3;break;case i.TRIANGLE_STRIP:t.triangleCount+=s.count-2}},this),r.states.restore(i),void 0!==r.renderTarget&&r.renderTarget.end(i),r.clear()},this),this.layers.length=0,this.currentRenderLayer=void 0,this.currentRenderable=void 0},addRenderLayer:function(e){if(void 0!==e.length)for(var t=0;t<e.length;++t)this.layers.push(e[t]);else this.layers.push(e)}},t}),define("Utils/File",[],function(){"use strict";function e(){this._paths=[],this._backupPaths=[],this.reset()}var t=window.JSON,i=0,n=1,r=2,s=3,o=0,a=1,h=function(e){return 0===e.search(/https?:\/\//i)},u=function(e){return-1===e.search(/https?:\/\//i)},c=function(e,t){var i,n,r=e.replace("\\","/"),s=r.match(/(https?):\/\/([^\/]+)\//i);null!==s&&s.length>=3&&(i=s[1],n=s[2],r=r.slice(s[0].length));for(var o=r.split("/"),h="",u=o.length;--u>=0;)0===o[u].length&&o.splice(u,1);for(;u<o.length;)switch(h=o[u]){case".":o.splice(u,1);break;case"..":u>0?(u-=1,o.splice(u,2)):u+=1;break;default:u+=1}return o.length<1?t===a?"./":"":(t===a&&"?"===o[o.length-1][0]&&o.pop(),r=o.join("/"),t===a&&(r+="/"),void 0!==i&&void 0!==n&&(r=i+"://"+n+"/"+r),r)},d=function(e,t,o,a){var h=new XMLHttpRequest;switch(h.open("GET",e,!0),t){case i:h.responseType="text";break;case n:h.responseType="json";break;case r:h.responseType="arraybuffer";break;case s:var u=new Image;return u.onload=function(){o(u)},u.onerror=a,void(u.src=e);default:h.responseType="text"}h.onreadystatechange=function(){4===h.readyState&&(200===h.status?("json"===h.responseType&&null===h.response&&(console.warn("could load '"+e+"' but couldn't deserialize it as a json object"),o(void 0)),o(h.response)):void 0!==a&&a(h.status))},h.send()};return e.prototype={TEXT:i,JSON:n,BINARY:r,IMAGE:s,FILE:o,DIRECTORY:a,reset:function(e){this._paths.length=0,this._backupPaths.length=0,this.registerPath(c(e||document.URL,a))},registerPath:function(e){e=u(e)?c(this._paths[0]+e,a):c(e,a),-1===this._paths.indexOf(e)&&this._paths.push(e)},pushPaths:function(){this._backupPaths.push(t.parse(t.stringify(this._paths)))},getPaths:function(){return t.parse(t.stringify(this._paths))},setPaths:function(e){if(this._paths.length=1,"string"==typeof e)this.registerPath(e);else{if("object"!=typeof e)throw"invalid paramter";e.forEach(function(e){this.registerPath(e)},this)}},popPaths:function(){this._paths=this._backupPaths.pop()},load:function(e,t,i,n){if(h(e))d(e,t,function(t){i({path:c(e,o),content:t})},n);else{var r=this.getPaths(),s=function(){if(0===r.length)return void(void 0!==n&&n());var a=r.pop();d(c(a+e,o),t,function(t){i({path:c(a+e,o),content:t})},s)};s()}},loadText:function(e,t,n){return this.load(e,i,t,n)},loadJSON:function(e,t,i){return this.load(e,n,t,i)},loadBinary:function(e,t,i){return this.load(e,r,t,i)},loadImage:function(e,t,i){return this.load(e,s,t,i)},loadMultiple:function(e,t,i){var n=[],r=0,s=!1,o=function(o,a){n[o]=a,void 0===a&&(s=!0),++r===e.length&&(s===!1?t(n):void 0!==i&&i())};e.forEach(function(e,t){this.load(e.url,e.type,function(e){o(t,e)},function(){o(t)})},this)}},{createFileSystem:function(){return new e},getDirectory:function(e){var t=c(e,o),i=t.lastIndexOf("/");return-1===i?"./":t.substr(0,i+1)},exists:function(e,t){var i=new XMLHttpRequest;i.open("HEAD",e,!0),i.onreadystatechange=function(){2===i.readyState&&t(200===i.status)},i.send()},TEXT:i,JSON:n,BINARY:r,IMAGE:s,FILE:o,DIRECTORY:a,load:d,normalize:c,isAbsolute:h,isRelative:u}}),define("Utils/Logger",[],function(){"use strict";var e=0,t=1,i=2,n=3,r=e,s=[{name:"error",userLog:void 0,log:function(e){throw e}},{name:"warning",userLog:void 0,log:function(e){console.warn(e)}},{name:"info",userLog:void 0,log:function(e){console.info(e)}},{name:"debug",userLog:void 0,log:function(e){console.log(e)}}],o=function(e,t){r>=e&&(e=s[e],void 0!==e.userLog?e.userLog(t):e.log(t))};return{ERROR:e,WARNING:t,INFO:i,DEBUG:n,setHandler:function(e,t){void 0!==s[e]&&(s[e].userLog=t)},setLevel:function(e){r=e},error:function(t){o(e,t)},warning:function(e){o(t,e)},info:function(e){o(i,e)},debug:function(e){o(n,e)}}}),define("Core/Engine",["./EventHandler","./Node","Resources/ResourceManager","Renderer/Renderer","Animation/AnimationSystem","Utils/File","Utils/Logger"],function(e,t,i,n,r,s,o){"use strict";function a(e,t){this.gl=null,this.canvas=e,this.options=t||{},this.fileSystem=void 0,this.animationSystem=void 0,this.resourceManager=void 0,this.renderer=void 0,this.sceneGraph=void 0,this.passes=[],this.elapsedTime=0,this.time=0,this.stats={renderer:{triangleCount:0,vertexCount:0,drawCalls:0},fps:0},this._paused=!0,this._extensions={},this.init()}return a.prototype={init:function(){if(!this.canvas)throw o.error("Engine - no canvas set"),"no canvas";var a=this.canvas.clientWidth,h=this.canvas.clientHeight;a>0&&h>0&&(this.canvas.width=a,this.canvas.height=h);try{this.gl=this.canvas.getContext("webgl",this.options)}catch(u){throw o.error("Engine - couldn't get WebGL context: "+u.message),u.message}this._initExtensions(),a>0&&h>0&&this.gl.viewport(0,0,a,h),this.fileSystem=new s.createFileSystem,
this.resourceManager=new i(this),this.renderer=new n(this),this.sceneGraph=new t(this,"Scene"),this.eventHandler=new e({keyboardElement:document,mouseElement:this.canvas,disableContextMenu:!0,useCapture:!0}),this.animationSystem=new r(this);var c=this;this.canvas.onresize=function(){c.resize(c.canvas.clientWidth,c.canvas.clientHeight)},window.onresize=function(){c.resize(c.canvas.clientWidth,c.canvas.clientHeight)}},clear:function(){this.clearSceneGraph(),this.clearPasses()},clearSceneGraph:function(){this.sceneGraph.deinit(),this.sceneGraph=new t(this,"Scene")},clearPasses:function(){this.passes.forEach(function(e){e.deinit(this)},this),this.passes=[]},clearResources:function(){this.resourceManager.clear()},start:function(){this._paused=!1,requestAnimationFrame(this._run.bind(this))},stop:function(){this._paused=!0},isRunning:function(){return null!==this._runIntervalId},render:function(){this.resourceManager.clearCurrentResources();for(var e=0;e<this.passes.length;++e)this.passes[e]._base.enabled===!0&&this.passes[e].apply(this);this.renderer.render()},resize:function(e,t){this.canvas.width=e,this.canvas.height=t,this.gl.viewport(0,0,e,t),this.eventHandler._onresize(e,t)},hasExtension:function(e){return this._extensions[e]?!0:!1},_run:function(){var e=Date.now(),t=0,i=0,n=0;return function(){t=Date.now(),this.elapsedTime=(t-e)/1e3,this.time+=this.elapsedTime,e=t,this.render&&this.render(),i+=1,n+=this.elapsedTime,n>.5&&(this.stats.fps=2*i,n=0,i=0),this._paused===!1&&requestAnimationFrame(this._run.bind(this))}}(),_initExtensions:function(){var e=this.gl.getSupportedExtensions();o.info("WebGL extensions:");for(var t=0;t<e.length;++t)o.info("	"+e[t]);this._extensions.texture_filter_anisotropic=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this._extensions.texture_filter_anisotropic&&(this.gl.MAX_TEXTURE_MAX_ANISOTROPY_EXT=this._extensions.texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT,this.gl.TEXTURE_MAX_ANISOTROPY_EXT=this._extensions.texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT),this._extensions.standard_derivatives=this.gl.getExtension("OES_standard_derivatives")||this.gl.getExtension("WEBKIT_OES_standard_derivatives"),this._extensions.depth_texture=this.gl.getExtension("OES_WEBGL_depth_texture")||this.gl.getExtension("WEBGL_depth_texture")||this.gl.getExtension("WEBKIT_WEBGL_depth_texture"),this._extensions.element_index_uint=this.gl.getExtension("OES_element_index_uint"),this._extensions.texture_float=this.gl.getExtension("OES_texture_float")||this.gl.getExtension("WEBKIT_texture_float"),this._extensions.texture_float_linear=this.gl.getExtension("OES_texture_float_linear")||this.gl.getExtension("WEBKIT_texture_float_linear"),this._extensions.texture_half_float=this.gl.getExtension("OES_texture_half_float")||this.gl.getExtension("WEBKIT_texture_half_float"),this._extensions.texture_half_float_linear=this.gl.getExtension("OES_texture_half_float_linear")||this.gl.getExtension("WEBKIT_texture_half_float_linear"),this._extensions.draw_buffers=this.gl.getExtension("WEBGL_draw_buffers")}},a}),define("Loading/Loaders",[],function(){"use strict";var e={};return{register:function(t,i){e[t]=i},get:function(t){return e[t]}}}),define("Loading/CameraLoader",["./Loaders","Components/Camera","Components/CameraController"],function(e,t,i){"use strict";e.register("Camera",function(e,i){return new t(e.engine,i)}),e.register("CameraController",function(e,t){return new i(e.engine,t)})}),define("Loading/LightLoader",["./Loaders","Components/Light"],function(e,t){"use strict";e.register("DirectionalLight",function(e,i){return i.lightType=t.DIRECTIONAL,new t(e.engine,i)}),e.register("PointLight",function(e,i){return i.lightType=t.POINT,new t(e.engine,i)}),e.register("SpotLight",function(e,i){return i.lightType=t.SPOT,new t(e.engine,i)})}),define("Loading/MeshLoader",["./Loaders","Components/Mesh"],function(e,t){"use strict";e.register("Mesh",function(e,i){var n=e.resourceIDs,r=e.engine;if("string"==typeof i.shader){var s=e.getShader(i.shader);if(void 0===s)throw"couldn't load shader '"+i.shader+"'";i.shader=n.length,n[n.length]=s.clone()}i.shader=n[i.shader],i.vb=n[i.vb],i.ib=n[i.ib];for(var o=0;o<i.subsets.length;++o)if(i.subsets[o].textures)for(var a=0;a<i.subsets[o].textures.length;++a)i.subsets[o].textures[a]=n[i.subsets[o].textures[a]];return new t(r,i)})}),define("Passes/IPass",[],function(){"use strict";function e(){this.enabled=!0}return e.prototype={setCamera:function(e){this.camera=e,this.renderLayer.camera=e},setRenderTarget:function(e){this.renderTarget=e,this.renderLayer.renderTarget=e}},e}),define("Passes/UpdatePass",["./IPass","Components/Transformation","Utils/Utils"],function(e,t,i){"use strict";function n(e){}var r={CameraController:function(e,t,i){i.update()},Transformation:function(e,i,n){n.updateMatrix(i.parent.getComponent(t.type))},Light:function(e,t,i){i.update()}};return n.prototype={type:"UpdatePass",init:function(e){},deinit:function(e){},apply:function(e){e.animationSystem.update(e.elapsedTime,e.time),e.sceneGraph.walk({pre:function(t){var i=void 0;for(var n in r)i=t.getComponent(n),void 0!==i&&r[n](e,t,i)},post:function(t){var i=void 0;for(var n in r)i=t.getComponent(n),void 0!==i&&r[n](e,t,i)}})}},i.inherits(n,e),n}),define("Renderer/RenderLayer",["States/StateBlock"],function(e){"use strict";function t(){this.renderTarget=void 0,this.camera=void 0,this.shader=void 0,this.states=new e,this.renderables=[],this.lights=[]}return t.prototype={deinit:function(e){void 0!==this.shader&&this.shader.release(),void 0!==this.renderTarget&&this.renderTarget.deinit(e)},clear:function(){this.renderables.clear(),this.lights.clear()},addRenderable:function(e){if(void 0===e.vertexBuffer||void 0===e.indexBuffer)throw"invalid renderable";void 0===e.shader||e.shader.getResource().isValid()===!1&&void 0===this.shader||e.vertexBuffer.getResource().isValid()===!1||e.indexBuffer.getResource().isValid()===!1||this.renderables.push(e)},addRenderables:function(e){for(var t=0;t<e.length;++t)this.addRenderable(e[t])},addLight:function(e){this.lights.push(e)}},t}),define("Passes/RenderPass",["./IPass","Renderer/RenderLayer","Components/Mesh","Components/Light","Utils/Utils"],function(e,t,i,n,r){"use strict";function s(e,i){this.renderLayer=new t,this.init(e,i)}return s.prototype={type:"RenderPass",init:function(e,t){t=t||{},t.renderTarget&&this.setRenderTarget(t.renderTarget),t.camera&&this.setCamera(t.camera)},deinit:function(e){this.renderLayer.deinit(e)},apply:function(e){e.sceneGraph.walk({pre:function(e){var t=0,r=e.components,s=r.length,o=void 0;for(t=0;s>t;++t)o=r[t],o.type==i.type?this.renderLayer.addRenderables(o.renderables):o.type===n.type&&this.renderLayer.addLight(o)}.bind(this)}),e.renderer.addRenderLayer(this.renderLayer)}},r.inherits(s,e),s}),define("Renderer/BackBufferTarget",["Core/EventHandler","Math/Vec4"],function(e,t){"use strict";function i(e,i){this.clearColor=new t(.2,.2,.2,1),this.clearBufferBit=e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT,this.width=e.canvas.width,this.height=e.canvas.height,this._listenerID=-1,this.init(e,i||{})}return i.prototype={init:function(e,t){this.clearColor=t.clearColor||this.clearColor,this.clearBufferBit=t.clearBufferBit||this.clearBufferBit,this._listenerID=e.eventHandler.addEventListener(this,this._processEvent)},deinit:function(e){e.eventHandler.removeEventListener(this._listenerID)},begin:function(e){e.viewport(0,0,this.width,this.height),-1!==this.clearBufferBit&&(e.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),e.clear(this.clearBufferBit))},end:function(e){},_processEvent:function(t){switch(t.type){case e.EVENTS.VIEWPORT:this.width=t.width,this.height=t.height}return!1}},i}),define("Loading/PassLoader",["./Loaders","Components/Camera","Passes/UpdatePass","Passes/RenderPass","Renderer/BackBufferTarget","Utils/Utils"],function(e,t,i,n,r,s){"use strict";e.register("UpdatePass",function(e){return new i(e.engine)}),e.register("RenderPass",function(e,i){var o=new n(e.engine,i),a=s.getMember(i,["camera","id"]);return void 0!==a&&(a=e.engine.sceneGraph.find("id",e.nodeIDs[a],!0),void 0!==a&&o.setCamera(a.getComponent(t.type))),o.setRenderTarget(e.loadObject(s.getMember(i,"renderTarget"))||new r(e.engine)),o})}),define("Renderer/FrameBufferTarget",["Math/Vec4"],function(e){"use strict";function t(t,i){this.clearColor=new e(.2,.2,.2,1),this.clearBufferBit=t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT,this.colorTarget=null,this.depthTarget=null,this.face=0,this.level=0,this.generateMips=!1,this.frameBuffer=null,this.width=0,this.height=0,this.init(t,i||{})}return t.prototype={init:function(e,t){var i=e.gl;if(this.clearColor.copy(t.clearColor||this.clearColor),this.clearBufferBit=t.clearBufferBit||this.clearBufferBit,this.face=t.face||this.face,this.level=t.level||this.level,this.generateMips=t.generateMips||this.generateMips,this.frameBuffer=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),void 0!==t.colorTarget){this.colorTarget=t.colorTarget.clone();var n=this.colorTarget.getResource();this.width=n.width,this.height=n.height,i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,n.target===i.TEXTURE_CUBE_MAP?i.TEXTURE_CUBE_MAP_POSITIVE_X+this.face:i.TEXTURE_2D,n.texture,this.level)}else this.clearBufferBit&=~i.COLOR_BUFFER_BIT;if(void 0!==t.depthTarget){this.depthTarget=t.depthTarget.clone();var n=this.depthTarget.getResource();0===this.width&&(this.width=n.width,this.height=n.height),i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,n.target===i.TEXTURE_CUBE_MAP?i.TEXTURE_CUBE_MAP_POSITIVE_X+this.face:i.TEXTURE_2D,n.texture,this.level)}else this.clearBufferBit&=~i.DEPTH_BUFFER_BIT;i.bindFramebuffer(i.FRAMEBUFFER,null)},deinit:function(e){null!==this.colorTarget&&this.colorTarget.release(),null!==this.depthTarget&&this.depthTarget.release(),e.gl.deleteFramebuffer(this.frameBuffer)},begin:function(e){e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer),e.viewport(0,0,this.width,this.height),this.clearBufferBit&e.COLOR_BUFFER_BIT&&e.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),-1!==this.clearBufferBit&&e.clear(this.clearBufferBit),null===this.colorTarget&&e.colorMask(!1,!1,!1,!1),null===this.depthTarget&&e.depthMask(!1)},end:function(e){if(e.bindFramebuffer(e.FRAMEBUFFER,null),null===this.colorTarget&&e.colorMask(!0,!0,!0,!0),null===this.depthTarget&&e.depthMask(!0),this.generateMips===!0){if(void 0!==this.colorTarget){var t=this.colorTarget.getResource();e.bindTexture(t.target,t.texture),e.generateMipmap(t.target)}if(void 0!==this.depthTarget){var t=this.depthTarget.getResource();e.bindTexture(t.target,t.texture),e.generateMipmap(t.target)}}}},t}),define("Loading/RenderTargetLoader",["./Loaders","Renderer/FrameBufferTarget","Renderer/BackBufferTarget"],function(e,t,i){"use strict";e.register("FrameBufferTarget",function(e,i){return new t(e.engine,i)}),e.register("BackBufferTarget",function(e,t){return new i(e.engine,t)})}),define("Loading/TransformationLoader",["./Loaders","Components/Transformation"],function(e,t){"use strict";e.register("Transformation",function(e,i){return new t(e.engine,i)})}),define("Loading/SceneLoader",["Core/Node","Utils/File","Resources/ResourceManager","./Loaders","./CameraLoader","./LightLoader","./MeshLoader","./PassLoader","./RenderTargetLoader","./TransformationLoader"],function(e,t,i,n){"use strict";function r(e,t){this.shaderLibrary=void 0,this.shaderLibraryFolder=void 0,this.engine=e,this.nodeIDs=[],this.resourceIDs=[],this.init(t)}return r.prototype={init:function(e){e=e||{};for(var t in e)this.hasOwnProperty(t)===!0&&(this[t]=e[t])},load:function(e,t){this.engine.fileSystem.pushPaths();var i=void 0,n=function(){"string"!=typeof this.shaderLibrary&&void 0!==i&&(this._process(i),this.engine.fileSystem.popPaths(),void 0!==t&&t())}.bind(this);void 0!==this.shaderLibrary?"string"==typeof this.shaderLibrary?this.engine.fileSystem.loadJSON(this.shaderLibrary,function(e){this._loadShaderLibrary(e),n()}.bind(this),function(){this._loadShaderLibrary(void 0)}.bind(this)):this._loadShaderLibrary(this.shaderLibrary):this.shaderLibrary=[],this.engine.fileSystem.loadJSON(e,function(e){i=e,n()}.bind(this),function(){this.engine.fileSystem.popPaths()}.bind(this))},_process:function(e){this.engine.fileSystem.registerPath(t.getDirectory(e.path)),e=e.content,this._loadResources(e.resources),this._loadSceneGraph(e.sceneGraph),this._loadPasses(e.passes),this._loadAnimations(e.animations),this.resourceIDs.forEach(function(e){e.release()})},loadObject:function(e){if(void 0!==e){var t=e.type;if(e=e.descriptor,void 0!==t&&void 0!==e){var i=n.get(t);return void 0!==i?i(this,e):void 0}}},getShader:function(e){if(void 0!==this.shaderLibrary&&this.shaderLibrary.hasOwnProperty(e)!==!1){var t=this.shaderLibrary[e];if(void 0===t.resourcePointer){if(void 0!==this.shaderLibraryFolder&&(this.engine.fileSystem.pushPaths(),this.engine.fileSystem.registerPath(this.shaderLibraryFolder)),this.shaderLibrary[e]=this.engine.resourceManager.create(i.SHADER,t),void 0===this.shaderLibrary[e])throw"fuck !";void 0!==this.shaderLibraryFolder&&this.engine.fileSystem.popPaths()}return this.shaderLibrary[e]}},_loadShaderLibrary:function(e){void 0===e?this.shaderLibrary=[]:(this.shaderLibraryFolder=t.getDirectory(e.path),this.shaderLibrary=e.content)},_loadResources:function(e){for(var t=this.engine.resourceManager,n=null,r=-1,s=0;s<e.length;++s){n=e[s];var r=n.id;switch(n.type){case"Shader":n=t.create(i.SHADER,n.descriptor);break;case"VertexBuffer":n=t.create(i.VERTEX_BUFFER,n.descriptor);break;case"IndexBuffer":n=t.create(i.INDEX_BUFFER,n.descriptor);break;case"Texture":n=t.create(i.TEXTURE,n.descriptor);break;default:continue}void 0!==n&&(this.resourceIDs[r]=n)}},_loadSceneGraph:function(e){for(var t=0;t<e.length;++t)this._loadNode(null,e[t])},_loadNode:function(t,i){null===t&&(t=this.engine.sceneGraph);var n=new e(this.engine,i.name);t.addChild(n),this.nodeIDs[i.id]=n.id;var r=void 0;if(i.components)for(var s=0;s<i.components.length;++s)r=this._loadComponent(i.components[s]),void 0!==r&&n.addComponent(r);if(i.children)for(var s=0;s<i.children.length;++s)this._loadNode(n,i.children[s])},_loadComponent:function(e){var t=void 0,i=e.type,r=n.get(i);return void 0!==r&&(t=r(this,e.descriptor)),t},_loadAnimations:function(e){if(void 0!==e&&void 0!==e.length&&0!==e.length)for(var t=this.engine.animationSystem,i=0;i<e.length;++i)t.addAnimation(e[i],this.nodeIDs)},_loadPasses:function(e){if(void 0!==e&&void 0!==e.length&&0!==e.length)for(var t=0;t<e.length;++t){var i=e[t],r=n.get(i.type);void 0!==r&&(i=r(this,i),i&&this.engine.passes.push(i))}}},r}),define("Passes/CompositingPass",["./IPass","Utils/Utils","Resources/ResourceManager","Renderer/RenderLayer","Renderer/Renderable"],function(e,t,i,n,r){"use strict";function s(e,t){this.renderLayer=new n,this.renderable=new r,this._shader={source:void 0,uniforms:void 0},this._textures=[],this._dirty=!1,this.init(e,t)}return s.prototype={type:"CompositingPass",init:function(e,t){},deinit:function(e){this.renderLayer.deinit(e),this.renderable.deinit(),this._textures.forEach(function(e){e.release()},this),this._textures.length=0},apply:function(e){this._dirty===!0&&this._updateRenderable(e),void 0!==this.renderable.shader&&void 0!==this.renderable.vertexBuffer&&void 0!==this.renderable.indexBuffer&&(this.renderLayer.addRenderable(this.renderable),e.renderer.addRenderLayer(this.renderLayer))},setTexture:function(e,t){void 0!==this._textures[e]&&(this._textures[e].release(),this._textures[e]=void 0),this._textures[e]=t.clone(),this._dirty=!0},setShader:function(e,t,i){this._shader.source="string"!=typeof source?e.join("\n"):e,this._shader.uniforms=t,this._shader.defines=i,this._dirty=!0},_updateRenderable:function(e){if(void 0!==this._shader.source){var t=e.resourceManager,n=e.gl,r=this._textures;this.renderable.deinit();var s={usage:n.STATIC_DRAW,streams:[{semantic:"position",type:n.FLOAT,size:2,data:[-1,1,-1,-1,1,1,1,-1]}]},o={type:n.UNSIGNED_BYTE,usage:n.STATIC_DRAW,data:[0,1,2,3]};this.renderable.primitiveType=n.TRIANGLE_STRIP,this.renderable.count=4,this.renderable.vertexBuffer=t.create(i.VERTEX_BUFFER,s),this.renderable.indexBuffer=t.create(i.INDEX_BUFFER,o),this.renderable.shader=t.create(i.SHADER,this._getShaderDescriptor(e)),r.forEach(function(e){this.renderable.textures.push(e.clone())},this),this._dirty=!1}},_getShaderDescriptor:function(e){var t="";t+="precision mediump float;\n",t+="attribute vec2 aPosition;\n",t+="varying vec2 vTexCoord;\n",t+="void main() {\n",t+="    gl_Position = vec4(aPosition, 0.0, 1.0);\n",t+="    vTexCoord = aPosition * 0.5 + 0.5;\n",t+="}\n";var i="precision mediump float;\n";i+="varying vec2 vTexCoord;\n";for(var n=this._shader.defines||[],r=0;r<n.length;++r)i+="#define "+n[r].name+" "+n[r].value+"\n";return i+=this._shader.source,{vs:t,fs:i,attributes:[{semantic:"position",name:"aPosition"}],uniforms:this._shader.uniforms||[]}}},t.inherits(s,e),s}),define("Passes/DebugTexturePass",["./IPass","Utils/Utils","Resources/ResourceManager","Renderer/RenderLayer","Renderer/Renderable"],function(e,t,i,n,r){"use strict";function s(e,t){this.renderLayer=new n,this.corner="UPPER_LEFT",this.orientation="HORIZONTAL",this.size=60,this._renderables=[],this._shaders=[],this._engine=e,this.init(e,t||{})}return s.prototype={type:"DebugTexturePass",init:function(e,t){this.corner=t.corner||this.corner,this.orientation=t.orientation||this.orientation,this.size=t.size||this.size},deinit:function(e){for(var t=0;t<this._renderables.length;++t)this._renderables[t].deinit(e);this._renderables.clear()},apply:function(e){this.renderLayer.addRenderables(this._renderables),e.renderer.addRenderLayer(this.renderLayer)},addTexture:function(e){var t=this._createRenderable();t.shader=this._createShader("DEFAULT"),t.textures[0]=e,this._renderables.push(t)},addDepthTexture:function(e){var t=this._createRenderable();t.shader=this._createShader("DEPTH"),t.textures[0]=e,this._renderables.push(t)},replaceTexture:function(e,t){for(var i=0;i<this._renderables.length;++i)if(this._renderables[i].textures[0]===e){this._renderables[i].textures[0]=t;break}},removeTexture:function(e){for(var t=0;t<this._renderables.length;++t)if(this._renderables[t].textures[0]===e){this._renderables[t].deinit(this._engine),this._renderables.remove(this._renderables[t]);break}},_createRenderable:function(){var e=this._engine.resourceManager,t=this._engine.gl,n=0===this._renderables.length?-1:-1+this._renderables.length*this.size/this._engine.canvas.width*2,s=this.size/this._engine.canvas.width*2,o=s*(this._engine.canvas.width/this._engine.canvas.height),a=new r;return a.primitiveType=t.TRIANGLE_STRIP,a.count=4,a.vertexBuffer=e.create(i.VERTEX_BUFFER,{usage:t.STATIC_DRAW,streams:[{semantic:"position",type:t.FLOAT,size:2,data:[n,1,n,1-o,n+s,1,n+s,1-o]},{semantic:"texcoord0",type:t.FLOAT,size:2,data:[0,1,0,0,1,1,1,0]}]}),a.indexBuffer=e.create(i.INDEX_BUFFER,{type:t.UNSIGNED_BYTE,usage:t.STATIC_DRAW,data:[0,1,2,3]}),a},_createShader:function(e){var t=this._engine.resourceManager;this._engine.gl;if(void 0!==this._shaders[e])return this._shaders[e];var n="precision mediump float;\n";n+="attribute vec2 aPosition;\n",n+="attribute vec2 aTexCoord0;\n",n+="varying vec2 vTexCoord;\n",n+="void main() {\n",n+="    gl_Position = vec4(aPosition, -1.0, 1.0);\n",n+="    vTexCoord = aTexCoord0;\n",n+="}";var r="precision mediump float;\n";switch(r+="varying vec2 vTexCoord;\n",r+="uniform sampler2D uSampler;\n",r+="uniform vec3 uLinearize;\n",r+="void main() {\n",e){case"DEPTH":r+="    float d = texture2D(uSampler, vTexCoord).r;\n",r+="    d = uLinearize.x / (d * uLinearize.y + uLinearize.z);\n",r+="    gl_FragColor = vec4(vec3(d), 1.0);\n",r+="}\n";break;default:case"DEFAULT":r+="    gl_FragColor = vec4(texture2D(uSampler, vTexCoord).rgb, 1.0);\n",r+="}\n"}var s=[{semantic:"position",name:"aPosition"},{semantic:"texcoord0",name:"aTexCoord0"}],o=[{name:"uSampler",reference:"texture",index:0}];switch(e){case"DEPTH":o.push({name:"uLinearize",reference:"linearizeDepth"});break;default:case"DEFAULT":}return this._shaders[e]=t.create(i.SHADER,{vs:n,fs:r,attributes:s,uniforms:o}),this._shaders[e]}},t.inherits(s,e),s}),define("Passes/ShadowPass",["./IPass","Components/Camera","Renderer/RenderLayer","Renderer/FrameBufferTarget","Resources/ResourceManager","Math/Vec3","Utils/Utils"],function(e,t,i,n,r,s,o){"use strict";function a(e,t){this.renderLayer=new i,this.renderables=[],this.init(e,t)}var h=new s,u={Mesh:function(e,t,i){e.renderer.currentRenderLayer.addRenderables(i.renderables)},Light:function(e,t,i){i.castShadow===!0&&(e.renderer.currentRenderLayer.camera.setLookAt(i.worldPosition,h.add(i.worldPosition,i.worldDirection)),e.renderer.currentRenderLayer.camera.setProjection(2*i.radius[1],1,.1,100))}};return a.prototype={type:"UpdatePass",init:function(e,i){this.renderLayer.shader=e.resourceManager.createShader({vs:["precision mediump float;","attribute vec3 aPosition;","uniform mat4 uWorldViewProjection;","void main()","{","    gl_Position = uWorldViewProjection * vec4(aPosition, 1);","}"],fs:["void main() { gl_FragColor = vec4(1.0); }"],attributes:[{semantic:"position",name:"aPosition"}],uniforms:[{name:"uWorldViewProjection",reference:"worldViewProjection"}]}),this.renderLayer.camera=new t(e),this.renderLayer.renderTarget=new n(e,{depthTarget:e.resourceManager.createTexture({size:i.size||512,mipmap:!1,format:e.gl.DEPTH_COMPONENT,internalFormat:e.gl.DEPTH_COMPONENT,type:e.gl.UNSIGNED_SHORT}),filter:e.gl.LINEAR})},deinit:function(e){this.shader.release(),this.renderLayer.deinit(e)},apply:function(e){e.renderer.currentRenderLayer=this.renderLayer,e.sceneGraph.walk({pre:function(t){var i=void 0;for(var n in u)i=t.getComponent(n),void 0!==i&&u[n](e,t,i)}}),e.renderer.addRenderLayer(this.renderLayer),e.renderer.currentRenderLayer=void 0},getShadowMap:function(){return this.renderLayer.renderTarget.depthTarget}},o.inherits(a,e),a}),define("States/BlendState",[],function(){"use strict";function e(e){this.mode=WebGLRenderingContext.FUNC_SUBTRACT,this.source=WebGLRenderingContext.ONE_MINUS_DST_COLOR,this.destination=WebGLRenderingContext.SRC_COLOR,this.init(e)}e.prototype={init:function(e){e=e||{};for(var t in e)e.hasOwnProperty(t)===!0&&this.hasOwnProperty(t)===!0&&(this[t]=e[t])},backup:function(i){return void 0===i&&(i=new e),i.init(t),i},set:function(e){this.mode!==t.mode&&(e.blendEquation(this.mode),t.mode=this.mode),(this.source!==t.source||this.destination!==t.destination)&&(e.blendFunc(this.source,this.destination),t.source=this.source,t.destination=this.destination)}};var t=new e;return e}),define("States/CullState",[],function(){"use strict";function e(e){this.enabled=!0,this.face=WebGLRenderingContext.BACK,this.init(e)}e.prototype={init:function(e){e=e||{};for(var t in e)e.hasOwnProperty(t)===!0&&this.hasOwnProperty(t)===!0&&(this[t]=e[t])},backup:function(i){return void 0===i&&(i=new e),i.init(t),i},set:function(e){this.enabled!==t.enabled&&(this.enabled===!0?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),t.enabled=this.enabled),this.face!==t.face&&(e.cullFace(this.face),t.face=this.face)}};var t=new e;return e}),define("States/DepthState",[],function(){"use strict";function e(e){this.enabled=!0,this.init(e)}e.prototype={init:function(e){e=e||{};for(var t in e)e.hasOwnProperty(t)===!0&&this.hasOwnProperty(t)===!0&&(this[t]=e[t])},backup:function(i){return void 0===i&&(i=new e),i.init(t),i},set:function(e){this.enabled!==t.enabled&&(this.enabled===!0?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),t.enabled=this.enabled)}};var t=new e;return e}),define("States/WriteMaskState",[],function(){"use strict";function e(e){this.enableRed=!0,this.enableGreen=!0,this.enableBlue=!0,this.enableAlpha=!0,this.enableDepth=!0,this.init(e)}e.prototype={init:function(e){e=e||{};for(var t in e)e.hasOwnProperty(t)===!0&&this.hasOwnProperty(t)===!0&&(this[t]=e[t])},backup:function(i){return void 0===i&&(i=new e),i.init(t),i},set:function(e){(this.enableRed!==t.enableRed||this.enableGreen!==t.enableGreen||this.enableBlue!==t.enableBlue||this.enableAlpha!==t.enableAlpha)&&(e.colorMask(this.enableRed,this.enableGreen,this.enableBlue,this.enableAlpha),t.enableRed=this.enableRed,t.enableGreen=this.enableGreen,t.enableBlue=this.enableBlue,t.enableAlpha=this.enableAlpha),this.enableDepth!==t.enableDepth&&(e.depthMask(this.enableDepth),t.enableDepth=this.enableDepth)}};var t=new e;return e}),define("Utils/MeshHelper",["Components/Mesh","States/WriteMaskState","States/CullState","Math/Vec3","Math/Mat4"],function(e,t,i,n,r){"use strict";function s(t,i){return i=i||{},new e(t,{vb:t.resourceManager.createVertexBuffer({streams:[{semantic:"position",type:WebGLRenderingContext.FLOAT,size:4,data:[-1,1,i.depth||0,1,-1,-1,i.depth||0,1,1,1,i.depth||0,1,1,-1,i.depth||0,1]}]}),ib:t.resourceManager.createIndexBuffer({type:WebGLRenderingContext.UNSIGNED_BYTE,data:[0,1,2,3]}),autoReleaseBuffers:!0,subsets:[{count:4,primitiveType:WebGLRenderingContext.TRIANGLE_STRIP}]})}function o(t,i){i=i||{};var r=t.resourceManager,s=.5*(i.size||1),o=i.faceNormals===!0?!0:!1,a=void 0,h={subsets:[{count:36}]},u={streams:[{semantic:"position",type:WebGLRenderingContext.FLOAT,size:3,data:[-s,s,s,s,s,s,s,s,-s,-s,s,-s,-s,-s,s,-s,-s,-s,s,-s,-s,s,-s,s,-s,-s,s,s,-s,s,s,s,s,-s,s,s,-s,-s,-s,-s,s,-s,s,s,-s,s,-s,-s,-s,-s,s,-s,s,s,-s,s,-s,-s,-s,-s,s,-s,s,s,-s,-s,s,s,-s,s,s,s]},{semantic:"normal",type:WebGLRenderingContext.FLOAT,size:3,data:[]}]},c={type:WebGLRenderingContext.UNSIGNED_BYTE,data:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]};if(o===!0)u.streams[1].data=[0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0];else for(var d=u.streams[0].data,f=u.streams[1].data,l=new n,p=0;p<d.length;p+=3)l.set(d[p],d[p+1],d[p+2]).normalize(),f.push(l[0]),f.push(l[1]),f.push(l[2]);return h.vb=r.createVertexBuffer(u),h.ib=r.createIndexBuffer(c),h.autoReleaseBuffers=!0,h.shader=void 0!==i.shader?i.shader.clone():void 0,a=new e(t,h)}function a(t,i){var r,s,o,a,h,u=[],c=[],d=[],f=WebGLRenderingContext.UNSIGNED_INT,l=i.radius||1,p=i.subdivisions||[32,16],v=p[0],g=2*Math.PI/v,m=p[1],_=Math.PI/m,b=void 0!==i.faceNormals?i.faceNormals:!1,y=i.textures||[],E=i.shader||void 0,T=new n,x=new n,R=new n,S=new n,w=new n,M=new n;for(s=0;v>s;++s)r=u.length/3,d.push(r,r+1,r+2),a=s+1,T.set(l,0,0).toCartesian(),x.set(l,_,g*a).toCartesian(),R.set(l,_,g*s).toCartesian(),u.push(T[0],T[1],T[2]),u.push(x[0],x[1],x[2]),u.push(R[0],R[1],R[2]);for(s=1;m-1>s;++s)for(o=0;v>o;++o)r=u.length/3,d.push(r,r+1,r+2),d.push(r,r+2,r+3),a=s+1,h=o+1,T.set(l,_*s,g*o).toCartesian(),x.set(l,_*s,g*h).toCartesian(),R.set(l,_*a,g*h).toCartesian(),S.set(l,_*a,g*o).toCartesian(),u.push(T[0],T[1],T[2]),u.push(x[0],x[1],x[2]),u.push(R[0],R[1],R[2]),u.push(S[0],S[1],S[2]);for(s=0;v>s;++s)r=u.length/3,d.push(r,r+1,r+2),a=s+1,T.set(l,Math.PI,0).toCartesian(),x.set(l,Math.PI-_,g*s).toCartesian(),R.set(l,Math.PI-_,g*a).toCartesian(),u.push(T[0],T[1],T[2]),u.push(x[0],x[1],x[2]),u.push(R[0],R[1],R[2]);if(b)for(s=0;s<d.length;s+=3)T.set(u[3*d[s]],u[3*d[s]+1],u[3*d[s]+2]),x.set(u[3*d[s+1]],u[3*d[s+1]+1],u[3*d[s+1]+2]),R.set(u[3*d[s+2]],u[3*d[s+2]+1],u[3*d[s+2]+2]),w.sub(x,T),M.sub(R,T),S.cross(w,M),c[3*d[s]]=S[0],c[3*d[s]+1]=S[1],c[3*d[s]+2]=S[2],c[3*d[s+1]]=S[0],c[3*d[s+1]+1]=S[1],c[3*d[s+1]+2]=S[2],c[3*d[s+2]]=S[0],c[3*d[s+2]+1]=S[1],c[3*d[s+2]+2]=S[2];else for(s=0;s<u.length;s+=3)T.set(u[s],u[s+1],u[s+2]).normalize(),c.push(T[0],T[1],T[2]);return d.length<256?f=WebGLRenderingContext.UNSIGNED_BYTE:d.length<65536&&(f=WebGLRenderingContext.UNSIGNED_SHORT),new e(t,{textures:y,shader:E,vb:t.resourceManager.createVertexBuffer({streams:[{semantic:"position",type:WebGLRenderingContext.FLOAT,size:3,data:u},{semantic:"normal",type:WebGLRenderingContext.FLOAT,size:3,data:c}]}),ib:t.resourceManager.createIndexBuffer({type:f,data:d}),subsets:[{count:d.length}]})}function h(e,n){var s={vs:["precision highp float;","","uniform mat4 uOrientation;","uniform mat4 uOrientationProjection;","","attribute vec3 aPosition;","","varying vec3 vPosition;","","void main()","{","    vPosition = (uOrientation * vec4(aPosition, 0)).xyz;","    gl_Position = uOrientationProjection * vec4(aPosition, 1);","}"],fs:["precision mediump float;","","uniform samplerCube uSkySampler;","","varying vec3 vPosition;","","void main()","{","    gl_FragColor = textureCube(uSkySampler, normalize(vPosition));","}"],attributes:[{semantic:"position",name:"aPosition"}],uniforms:[{name:"uSkySampler",reference:"texture",index:0}]},a=e.resourceManager.createShader(s),h=o(e,{size:n.size||20,shader:a,faceNormals:!0});return h.renderables[0].textures.push(n.sky.clone()),h.renderables[0].states.add(new t({enableDepth:!1})),h.renderables[0].states.add(new i({face:e.gl.FRONT})),a.getResource().uniforms.push({location:e.gl.getUniformLocation(a.getResource().program,"uOrientation"),orientation:new r,value:new r,set:function(t){this.orientation.copy(e.renderer.currentRenderLayer.camera.viewMatrix),this.orientation.elements[12]=0,this.orientation.elements[13]=0,this.orientation.elements[14]=0,t.uniformMatrix4fv(this.location,!1,this.value.elements)}}),a.getResource().uniforms.push({location:e.gl.getUniformLocation(a.getResource().program,"uOrientationProjection"),orientation:new r,value:new r,camera:void 0,fovy:void 0,set:function(t){this.camera=e.renderer.currentRenderLayer.camera,this.fovy=this.camera.fovy,this.orientation.copy(this.camera.viewMatrix),this.orientation.elements[12]=0,this.orientation.elements[13]=0,this.orientation.elements[14]=0,this.camera.setFovy(Math.degToRad(90)),this.value.mul(this.camera.projectionMatrix,this.orientation),this.camera.setFovy(this.fovy),t.uniformMatrix4fv(this.location,!1,this.value.elements)}}),a.release(),h}return{createFullscreenQuad:s,createCube:o,createSphere:a,createSkyMesh:h}}),define("Utils/String",[],function(){"use strict";String.prototype.hashCode=function(){var e,t=0,i=this.length;if(0==i)return t;for(var n=0;i>n;n++)e=this.charCodeAt(n),t=(t<<5)-t+e,t|=0;return t}}),define("cgl",function(){});