require(["Core/Engine","Core/EventHandler","Components/Camera","Components/CameraController","Loading/SceneLoader","Passes/UpdatePass","Passes/DebugTexturePass","Passes/RenderPass","Passes/ShadowPass","Renderer/BackBufferTarget","loading","Math/Math"],function(e,a,o,r,i,n,t,s,u,d,l){"use strict";function m(){var e=(c.renderer,c.sceneGraph.find("name","Camera",!0).getComponent(o.type));p=new u(c,{size:1024}),g.uniforms.push({name:"uShadowMap",reference:"texture",value:p.getShadowMap()}),g=c.resourceManager.createShader(g),g.getResource().addUniform({location:c.gl.getUniformLocation(g.getResource().program,"uWorldToShadowMapMatrix"),set:function(e){e.uniformMatrix4fv(this.location,!1,p.renderLayer.camera.viewProjectionMatrix.elements)}}),h=new s(c),h.setRenderTarget(new d(c)),h.setCamera(e),h.renderLayer.shader=g,f=new t(c,{size:c.canvas.width/4}),f.setRenderTarget(new d(c,{clearBufferBit:-1})),f.setCamera(e),f.addDepthTexture(p.getShadowMap()),c.passes.push(new n(c)),c.passes.push(p),c.passes.push(h),c.passes.push(f)}var c,p,h,f,g={vs:["precision highp float;","uniform mat4 uWorld;","uniform mat4 uNormal;","uniform mat4 uWorldViewProjection;","attribute vec3 aPosition;","attribute vec3 aNormal;","varying vec3 vPosition;","varying vec3 vNormal;","void main()","{","    gl_Position = uWorldViewProjection * vec4(aPosition, 1);","    vPosition = (uWorld * vec4(aPosition, 1)).xyz;","    vNormal = (uNormal * vec4(aNormal, 0)).xyz;","}"],fs:["precision highp float;","uniform mat4 uWorldToShadowMapMatrix;","uniform sampler2D uShadowMap;","uniform vec3 uLightPosition;","uniform vec3 uLightDirection;","uniform vec2 uLightSpotRadius;","uniform vec3 uLinearizeDepth;","varying vec3 vPosition;","varying vec3 vNormal;","","vec2 spotRadius = cos(uLightSpotRadius);","","void main()","{","    float ndotl = dot(normalize(vNormal), -uLightDirection);","    float diffuse = dot(normalize(vPosition - uLightPosition), uLightDirection);","    diffuse = smoothstep(spotRadius.y, spotRadius.x, diffuse) * ndotl;","","    vec4 proj = uWorldToShadowMapMatrix * vec4(vPosition, 1);","    proj.xyz /= proj.w;","    proj.xy = proj.xy * 0.5 + 0.5;","    float shadowSample = texture2D(uShadowMap, proj.xy).x;","","    proj.z = uLinearizeDepth.x / (proj.z * uLinearizeDepth.y + uLinearizeDepth.z);","    shadowSample = uLinearizeDepth.x / (shadowSample * uLinearizeDepth.y + uLinearizeDepth.z);","","    float shadow = max(0.3, float(shadowSample - proj.z > 0.05));","","    gl_FragColor = vec4(vec3(diffuse * shadow), 1.0);","}"],attributes:[{semantic:"position",name:"aPosition"},{semantic:"normal",name:"aNormal"}],uniforms:[{name:"uWorld",reference:"world"},{name:"uNormal",reference:"normal"},{name:"uWorldViewProjection",reference:"worldViewProjection"},{name:"uLinearizeDepth",reference:"linearizeDepth"},{name:"uLightPosition",reference:"lightPosition",index:0},{name:"uLightDirection",reference:"lightDirection",index:0},{name:"uLightSpotRadius",reference:"lightSpotRadius",index:0}]};c=new e(document.getElementById("webgl2"),{antialias:!0,debug:!1}),c.gl.enable(c.gl.DEPTH_TEST),c.gl.enable(c.gl.CULL_FACE),l.startLoading("loading",50,"Loading ..."),new i(c,{shaderLibrary:"shaders.json"}).load("scene.json",function(){m(),c.start();var e=function(){0===c.stats.renderer.drawCalls?requestAnimationFrame(e):l.stopLoading()};e()})});