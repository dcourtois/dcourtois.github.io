require(["Core/Engine","Core/EventHandler","Components/Camera","Math/Vec2","Math/Vec3","Loading/SceneLoader","Resources/ResourceManager","Passes/UpdatePass","Passes/RenderPass","Passes/CompositingPass","Passes/DebugTexturePass","Renderer/BackBufferTarget","Renderer/FrameBufferTarget","Utils/File","loading"],function(e,a,t,r,n,s,d,o,u,i,l,p,m,h,c){"use strict";function g(){for(var e=4*Math.floor(Math.sqrt(L.samples)),a=[],t=0;e>t;++t)for(var r=0;e>r;++r){var s=new n(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1).normalize();s.mulScalarSelf(Math.random()),s.addScalarSelf(1).mulScalarSelf(.5).mulScalarSelf(255),a.push(Math.round(s[0])),a.push(Math.round(s[1])),a.push(Math.round(s[2])),a.push(0)}return S.resourceManager.create(d.TEXTURE,{width:e,height:e,data:a,mipmap:!1,filter:S.gl.NEAREST,wrap:S.gl.REPEAT})}function f(){var e=document.getElementById("gui");D=new dat.GUI({width:e.clientWidth,autoPlace:!1}),e.appendChild(D.domElement),D.add(L,"showTextures").name("show textures").onChange(function(e){E._base.enabled=e});var t=D.addFolder("SSAO Pass");t.open(),t.add(P,"radius"),M?t.add(P,"depthClamp").name("depth clamp"):t.add(L,"ssaoDepthClamp").name("depth clamp").onChange(function(e){P.depthClamp=e?.05:1}),t.add(L,"samples",[4,16,64]).onFinishChange(function(e){var a=R;R=g(),w.setTexture(1,R),E.replaceTexture(a,R),x(),a.release}),t.add(L,"downsample",{None:1,2:2,4:4}).onChange(function(e){var a=w.renderTarget;w.setRenderTarget(new m(S,{width:S.canvas.width/L.downsample,height:S.canvas.height/L.downsample,depth:!1,filter:S.gl.LINEAR})),v.setTexture(2,w.renderTarget.colorTexture),E.replaceTexture(a.colorTexture,w.renderTarget.colorTexture),a.deinit(S)});var r=D.addFolder("Compositing Pass");r.open(),r.add(L,"blur").onChange(function(e){A.blur=e?"1.0":"0.0"}),M?(r.add(A,"depthClamp").name("depth clamp"),r.add(L,"ssao 0").onChange(function(e){A.ssao[0]=e}),r.add(L,"ssao 1").onChange(function(e){A.ssao[1]=e})):r.add(L,"compositingDepthClamp").name("depth aware blur").onChange(function(e){A.depthClamp=e?.005:1}),r.add(L,"composition",{"Diffuse + SSAO":0,Diffuse:1,SSAO:2}).onChange(function(e){switch(e){case"0":A.debug=[1,0,0];break;case"1":A.debug=[0,1,0];break;case"2":A.debug=[0,0,1]}}),D.close(),S.eventHandler.addEventListener(this,function(t){switch(t.type){case a.EVENTS.VIEWPORT:D.width=e.clientWidth}return!1})}function T(){var e=S.sceneGraph.find("name","Camera",!0).getComponent(t.type),a=new o(S);R=g(),b=new u(S),b.setRenderTarget(new m(S)),b.setCamera(e);var r=S.canvas.width/L.downsample,n=S.canvas.height/L.downsample;w=new i(S),w.setRenderTarget(new m(S,{width:r,height:n,depth:!1,filter:S.gl.LINEAR})),w.setTexture(0,b.renderTarget.depthTexture),w.setTexture(1,R),w.setCamera(e),x(),v=new i(S),v.setRenderTarget(new p(S)),v.setCamera(e),v.setTexture(0,b.renderTarget.colorTexture),v.setTexture(1,b.renderTarget.depthTexture),v.setTexture(2,w.renderTarget.colorTexture),C(),E=new l(S,{size:S.canvas.width/4}),E.setRenderTarget(new p(S,{clearBufferBit:-1})),E.setCamera(e),E.addTexture(b.renderTarget.colorTexture),E.addDepthTexture(b.renderTarget.depthTexture),E.addTexture(w.renderTarget.colorTexture),E.addTexture(R),E._base.enabled=L.showTextures,S.passes.push(a),S.passes.push(b),S.passes.push(w),S.passes.push(v),S.passes.push(E)}function x(){h.load("ssao.glsl",h.TEXT,function(e){w.setShader(e,[{name:"uDepthSampler",reference:"texture",index:0},{name:"uRandomSampler",reference:"texture",index:1},{name:"uInverseProjectionMatrix",reference:"inverseProjection"},{name:"uProjectionMatrix",reference:"projection"},{name:"uDepthTextureSize",reference:"textureSize",index:0},{name:"uRandomTextureSize",reference:"textureSize",index:1},{name:"uLinearizeDepth",reference:"linearizeDepth"},{name:"uRadius",type:"float",object:P,attribute:"radius"},{name:"uClamp",type:"float",object:P,attribute:"depthClamp"}],[{name:"SSAO_SAMPLES",value:Math.floor(Math.sqrt(L.samples))}])})}function C(){h.load("compositing.glsl",h.TEXT,function(e){v.setShader(e,[{name:"uDiffuseSampler",reference:"texture",index:0},{name:"uDepthSampler",reference:"texture",index:1},{name:"uSSAOSampler",reference:"texture",index:2},{name:"uSSAOTextureSize",reference:"textureSize",index:2},{name:"uLinearizeDepth",reference:"linearizeDepth"},{name:"uBlur",type:"float",object:A,attribute:"blur"},{name:"uClamp",type:"float",object:A,attribute:"depthClamp"},{name:"uSSAOContribution",type:"vec2",object:A,attribute:"ssao"},{name:"uDebugComposition",type:"vec3",object:A,attribute:"debug"}],[{name:"BLUR_RADIUS",value:4}])})}var S=void 0,b=void 0,w=void 0,v=void 0,E=void 0,R=void 0,D=void 0,M=!1,P={radius:.09,depthClamp:.05},A={blur:1,depthClamp:.005,ssao:[1.8,-.2],debug:[1,0,0]},L={showTextures:!1,model:0,ssaoDepthClamp:1!==P.depthClamp,samples:16,downsample:1,compositingDepthClamp:1!==A.depthClamp,blur:1===A.blur,"ssao 0":A.ssao[0],"ssao 1":A.ssao[1],composition:1===A.debug[0]?0:1===A.debug[1]?1:2};S=new e(document.getElementById("webgl2"),{antialias:!0,debug:!0}),S.gl.enable(S.gl.DEPTH_TEST),S.gl.enable(S.gl.CULL_FACE),c.startLoading("loading",50,"Loading ...");var j=new s(S,{shaderLibrary:"../shaderlibrary/shaders.json"});j.load("scene.json",function(){T(),S.start();var e=function(){0===S.stats.renderer.drawCalls?requestAnimationFrame(e):(f(),c.stopLoading())};e()})});